<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè´¦å·åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            font-size: 15px;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 15px;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 0;
            position: relative;
        }
        
        /* è¡¨æ ¼å®¹å™¨æ»šåŠ¨æ¡æ ·å¼ */
        .table-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .table-container th {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            font-size: 15px;
            color: #374151;
            background: #f9fafb;
            white-space: nowrap;
        }
        
        .table-container td {
            padding: 14px 16px;
            font-size: 15px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .table-container tbody tr:hover {
            background: #f9fafb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            font-size: 14px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            color: #6b7280;
            font-size: 14px;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-socks5 {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-trojan {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge-http {
            background: #dcfce7;
            color: #166534;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
        }

        .btn-icon:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #111827;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #111827;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 15px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            display: inline-block;
        }

        .status-dot.online {
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .status-dot.other {
            background: #6b7280;
        }

        .status-dot.unauthorized {
            background: #f59e0b;
        }

        .status-text.online {
            color: #10b981;
        }

        .status-text.offline {
            color: #ef4444;
        }

        .status-text.other {
            color: #6b7280;
        }

        .status-text.unauthorized {
            color: #f59e0b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .json-display {
            background: #f9fafb;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            flex: 1;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }
        
        .tab-content.active {
            display: flex !important;
        }
        
        /* æœç´¢å’Œå·¥å…·æ åŒºåŸŸ */
        .toolbar-wrapper {
            flex-shrink: 0;
            margin-bottom: 15px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            max-width: 450px;
            padding: 12px 18px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* è¡¨æ ¼å®¹å™¨ - å¯æ»šåŠ¨ */
        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            min-height: 0;
            position: relative;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .table-wrapper::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
        
        /* å›ºå®šè¡¨å¤´çš„è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: auto;
        }
        
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 15px;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 14px 16px;
            font-size: 15px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table tbody tr:hover {
            background: #f9fafb;
        }
        
        /* åˆ†é¡µç»„ä»¶ */
        .pagination-wrapper {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .pagination-info {
            color: #6b7280;
            font-size: 15px;
        }
        
        .pagination {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .pagination button {
            padding: 8px 14px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            min-width: 40px;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #667eea;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #6b7280;
        }
        
        .page-size-selector select {
            padding: 8px 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-size-selector select:hover {
            border-color: #667eea;
        }
        
        .page-size-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 1024px) {
            body {
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 20px;
            }
            
            .tab-btn {
                font-size: 15px;
                padding: 12px 20px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                font-size: 13px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                width: 100%;
                justify-content: center;
                font-size: 13px;
            }
            
            .search-input {
                max-width: 100%;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: left;
                border-bottom: none;
                border-left: 3px solid transparent;
                margin-bottom: 0;
            }

            .tab-btn.active {
                border-left-color: #667eea;
                border-bottom-color: transparent;
            }
        }

        /* è®¾å¤‡é€‰æ‹©å™¨æ ·å¼ */
        .device-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .device-selector label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }

        .device-selector select {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            min-width: 200px;
        }

        .device-selector select:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .device-selector select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 15px;">
                <div style="text-align: center;">
                    <h1>å¤šè´¦å·åå°ç®¡ç†ç³»ç»Ÿ</h1>
                    <!-- è®¾å¤‡é€‰æ‹©å™¨ï¼ˆåªè¯»å±•ç¤ºï¼‰ -->
                    <div class="device-selector" style="justify-content: center; margin-top: 10px;">
                        <label>ğŸ“± å½“å‰è®¾å¤‡:</label>
                        <span id="currentDeviceDisplay" style="color: white; font-weight: 600; font-size: 14px;">
                            åŠ è½½ä¸­...
                        </span>
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="showPathSettingsModal()" style="padding: 10px 20px; position: absolute; right: 30px; top: 50%; transform: translateY(-50%);">
                âš™ï¸ è·¯å¾„è®¾ç½®
            </button>
        </div>

        <div class="content">
            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
                <button class="tab-btn active" onclick="switchTab('devices')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                    ğŸ“± è®¾å¤‡ç®¡ç†
                </button>
                <button class="tab-btn" onclick="switchTab('proxies')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                    ğŸ“‹ ä»£ç†åˆ—è¡¨
                </button>
                <button class="tab-btn" onclick="switchTab('transit')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                    ğŸ”— ä¸­è½¬çº¿è·¯åˆ—è¡¨
                </button>
                <button class="tab-btn" onclick="switchTab('vm')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px;">
                    ğŸ–¥ï¸ VM ç®¡ç†
                </button>
            </div>

            <!-- è®¾å¤‡ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="devices-tab" class="tab-content" style="display: block;">
                <div class="toolbar">
                    <div>
                        <button class="btn btn-secondary" onclick="refreshDeviceList()">
                            ğŸ”„ åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                        </button>
                    </div>
                    <div id="device-count" style="color: #6b7280; font-size: 14px;">
                        åŠ è½½ä¸­...
                    </div>
                </div>

                <div id="device-alert-container"></div>

                <!-- å·²è¿æ¥è®¾å¤‡åˆ—è¡¨ -->
                <div>
                    <h3 style="font-size: 18px; margin-bottom: 15px; color: #374151;">ğŸ”Œ å·²è¿æ¥è®¾å¤‡ï¼ˆå®æ—¶æ‰«æï¼‰</h3>
                    <div class="table-container">
                        <div id="devices-scan-loading" class="loading" style="display: none;">æ­£åœ¨æ‰«æè®¾å¤‡...</div>
                        <div id="devices-scan-empty" class="empty-state" style="display: none;">
                            <p>æš‚æ— è®¾å¤‡è¿æ¥</p>
                            <p style="font-size: 12px; margin-top: 5px; color: #9ca3af;">è¯·ç¡®ä¿è®¾å¤‡å·²é€šè¿‡USBè¿æ¥å¹¶å·²å¯ç”¨USBè°ƒè¯•</p>
                        </div>
                        <table id="devices-scan-table" class="data-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">å½“å‰è®¾å¤‡</th>
                                    <th>å¤‡æ³¨</th>
                                    <th>è®¾å¤‡ID</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="devices-scan-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ä»£ç†åˆ—è¡¨æ ‡ç­¾é¡µ -->
            <div id="proxies-tab" class="tab-content" style="display: none;">
                <div class="toolbar-wrapper">
                    <div class="toolbar">
                        <div>
                            <button class="btn btn-primary" onclick="showAddModal()">
                                â• æ·»åŠ ä»£ç†
                            </button>
                            <button class="btn btn-secondary" onclick="loadProxies()">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                        <div id="proxy-count" style="color: #6b7280; font-size: 14px;">
                            åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <!-- æœç´¢æ¡† -->
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="ğŸ” æœç´¢ä»£ç†åç§°..." 
                               oninput="searchProxies(this.value)">
                        <select id="proxy-dialer-filter" class="search-input" style="max-width: 250px;" 
                                onchange="filterProxiesByDialer(this.value)">
                            <option value="">å…¨éƒ¨ä¸­è½¬çº¿è·¯</option>
                        </select>
                        <div class="page-size-selector">
                            <span>æ¯é¡µæ˜¾ç¤º:</span>
                            <select onchange="paginationState.proxies.pageSize = parseInt(this.value); paginationState.proxies.currentPage = 1; renderProxiesPage();">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="alert-container"></div>

                <div class="table-container">
                    <div id="loading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="empty-state" class="empty-state" style="display: none;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>æš‚æ— ä»£ç†é…ç½®</p>
                    </div>
                    <table id="proxy-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ç´¢å¼•</th>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>åœ°åŒº</th>
                                <th>æœåŠ¡å™¨</th>
                                <th>ç«¯å£</th>
                                <th>ç”¨æˆ·å</th>
                                <th>ä¸­è½¬çº¿è·¯</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="proxy-tbody">
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div class="pagination-wrapper">
                    <div class="pagination-info" id="proxy-pagination-info"></div>
                    <div id="proxy-pagination"></div>
                </div>
            </div>

            <!-- ä¸­è½¬çº¿è·¯åˆ—è¡¨æ ‡ç­¾é¡µ -->
            <div id="transit-tab" class="tab-content" style="display: none;">
                <div class="toolbar-wrapper">
                    <div class="toolbar">
                    <div>
                        <button class="btn btn-primary" onclick="showAddTransitModal()">
                            â• æ·»åŠ ä¸­è½¬çº¿è·¯
                        </button>
                        <button class="btn btn-secondary" onclick="loadTransitProxies()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="transit-count" style="color: #6b7280; font-size: 14px;">
                        åŠ è½½ä¸­...
                    </div>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="ğŸ” æœç´¢ä¸­è½¬çº¿è·¯åç§°..." 
                           oninput="searchTransit(this.value)">
                    <div class="page-size-selector">
                        <span>æ¯é¡µæ˜¾ç¤º:</span>
                        <select onchange="paginationState.transit.pageSize = parseInt(this.value); paginationState.transit.currentPage = 1; renderTransitPage();">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>

                <div id="transit-alert-container"></div>

                <div class="table-container">
                    <div id="transit-loading" class="loading">åŠ è½½ä¸­...</div>
                    <div id="transit-empty-state" class="empty-state" style="display: none;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>æš‚æ— ä¸­è½¬çº¿è·¯é…ç½®</p>
                    </div>
                    <table id="transit-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ç´¢å¼•</th>
                                <th>åç§°</th>
                                <th>ç±»å‹</th>
                                <th>æœåŠ¡å™¨</th>
                                <th>ç«¯å£</th>
                                <th>ç”¨æˆ·å</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="transit-tbody">
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µæ§ä»¶ -->
                <div class="pagination-wrapper">
                    <div class="pagination-info" id="transit-pagination-info"></div>
                    <div id="transit-pagination"></div>
                </div>
            </div>

            <!-- VM ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="vm-tab" class="tab-content" style="display: none;">
                <div class="toolbar">
                    <div>
                        <button class="btn btn-primary" onclick="showVMNewModal()">
                            ğŸ†• åˆ›å»ºæ–°è´¦å·
                        </button>
                        <button class="btn btn-success" onclick="showVMLoadModal()">
                            â™»ï¸ åŠ è½½è´¦å·
                        </button>
                        <button class="btn btn-secondary" onclick="showVMSaveModal()">
                            ğŸ’¾ ä¿å­˜è´¦å·
                        </button>
                        <button class="btn btn-secondary" onclick="showRegionManageModal()">
                            ğŸŒ ç®¡ç†åœ°åŒº
                        </button>
                    </div>
                </div>

                <div id="vm-alert-container"></div>

                <!-- æ—¥å¿—è¾“å‡ºåŒºåŸŸ -->
                <div style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 18px; color: #374151;">ğŸ“‹ æ‰§è¡Œæ—¥å¿—</h3>
                        <button class="btn btn-sm btn-secondary" onclick="clearVMLog()" style="padding: 6px 12px; font-size: 12px;">
                            ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                        </button>
                    </div>
                    <div id="vm-log-container" style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 600px; overflow-y: auto; min-height: 400px;">
                        <div style="color: #6b7280;">ç­‰å¾…æ“ä½œ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="proxy-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ·»åŠ ä»£ç†</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <!-- æ·»åŠ æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
            <div id="proxy-mode-switch" style="display: none; margin-bottom: 20px; text-align: center;">
                <div style="display: inline-flex; background: #f3f4f6; border-radius: 8px; padding: 4px;">
                    <button type="button" class="mode-btn active" onclick="switchProxyMode('single')" 
                            style="padding: 8px 24px; border: none; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                        ğŸ“ å•æ¡æ·»åŠ 
                    </button>
                    <button type="button" class="mode-btn" onclick="switchProxyMode('batch')" 
                            style="padding: 8px 24px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                        ğŸ“‹ æ‰¹é‡å¯¼å…¥
                    </button>
                </div>
            </div>
            
            <!-- å•æ¡æ·»åŠ è¡¨å• -->
            <form id="proxy-form" onsubmit="saveProxy(event)">
                <div class="form-group">
                    <label>åç§° *</label>
                    <input type="text" name="name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç±»å‹ *</label>
                        <select name="type" required>
                            <option value="socks5" selected>socks5</option>
                            <option value="trojan">trojan</option>
                            <option value="http">http</option>
                            <option value="https">https</option>
                            <option value="ss">ss</option>
                            <option value="vmess">vmess</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åœ°åŒº *</label>
                        <div style="display: flex; gap: 8px;">
                            <select name="region" id="proxy-region-select" required style="flex: 1;">
                                <option value="">åŠ è½½ä¸­...</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="showRegionManageModal()" style="padding: 10px 16px; white-space: nowrap;">
                                âš™ï¸ ç®¡ç†
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>è·³è¿‡è¯ä¹¦éªŒè¯</label>
                        <select name="skip-cert-verify">
                            <option value="true" selected>æ˜¯</option>
                            <option value="false">å¦</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>æœåŠ¡å™¨ *</label>
                        <input type="text" name="server" required>
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£ *</label>
                        <input type="text" name="port" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·å *</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç  *</label>
                        <input type="text" name="password" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>SNI</label>
                    <input type="text" name="sni">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>UDP</label>
                        <select name="udp">
                            <option value="true" selected>æ˜¯ï¼ˆé»˜è®¤ï¼‰</option>
                            <option value="false">å¦</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Dialer Proxy (ä¸­è½¬çº¿è·¯)</label>
                        <select name="dialer-proxy" id="dialer-proxy-select">
                            <option value="">æ— ï¼ˆä¸ä½¿ç”¨ä¸­è½¬ï¼‰</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>å…¶ä»–å‚æ•° (JSON æ ¼å¼ï¼Œå¯é€‰)</label>
                    <textarea name="extra-params" rows="3" placeholder='{"key": "value"}' style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; font-family: 'Courier New', monospace;"></textarea>
                    <small style="color: #6b7280; font-size: 12px;">ä¾‹å¦‚: {"network": "tcp", "tls": true}</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
            
            <!-- æ‰¹é‡å¯¼å…¥è¡¨å• -->
            <form id="proxy-batch-form" onsubmit="saveBatchProxies(event)" style="display: none;">
                <div class="form-group">
                    <label>æ•°æ®æ ¼å¼ *</label>
                    <select name="format_type" required onchange="updateFormatHint()">
                        <option value="">è¯·é€‰æ‹©æ•°æ®æ ¼å¼</option>
                        <option value="format1">æ ¼å¼1: username:password:hostname:port</option>
                        <option value="format2">æ ¼å¼2: hostname:port:username:password</option>
                        <option value="format3">æ ¼å¼3: username:password@hostname:port</option>
                    </select>
                    <div id="format-hint" style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-left: 3px solid #3b82f6; font-size: 13px; color: #1e40af; display: none;">
                        <!-- æ ¼å¼æç¤ºå°†åŠ¨æ€æ˜¾ç¤º -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ä»£ç†åç§°å‰ç¼€ *</label>
                    <input type="text" name="name_prefix" required placeholder="ä¾‹å¦‚: UK, SG, HK">
                    <small style="color: #6b7280;">ä»£ç†åç§°å°†è‡ªåŠ¨ç”Ÿæˆä¸º: å‰ç¼€_001, å‰ç¼€_002, ...</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>åœ°åŒº *</label>
                        <select name="region" id="proxy-batch-region-select" required>
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä¸­è½¬çº¿è·¯</label>
                        <select name="dialer_proxy" id="proxy-batch-dialer-select">
                            <option value="">æ— ï¼ˆä¸ä½¿ç”¨ä¸­è½¬ï¼‰</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label style="font-size: 15px; font-weight: 600; margin-bottom: 8px; display: block;">
                        ä»£ç†æ•°æ® * 
                        <span style="color: #6b7280; font-weight: normal; font-size: 14px;">(æ¯è¡Œä¸€ä¸ªä»£ç†)</span>
                    </label>
                    <textarea name="proxy_lines" rows="12" required 
                              style="width: 100%; 
                                     padding: 16px; 
                                     border: 2px solid #d1d5db; 
                                     border-radius: 8px; 
                                     font-size: 15px; 
                                     font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                                     line-height: 1.6;
                                     resize: vertical;
                                     background: #f9fafb;
                                     transition: all 0.2s;"
                              onfocus="this.style.borderColor='#667eea'; this.style.background='white'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)';"
                              onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'; this.style.boxShadow='none';"
                              placeholder="è¯·ç²˜è´´ä»£ç†æ•°æ®ï¼Œæ¯è¡Œä¸€ä¸ª

ç¤ºä¾‹ï¼ˆæ ¹æ®é€‰æ‹©çš„æ ¼å¼ï¼‰ï¼š
user1:pass1:proxy1.com:8080
user2:pass2:proxy2.com:8080
user3:pass3:proxy3.com:8080

æ”¯æŒæ‰¹é‡ç²˜è´´ï¼Œè‡ªåŠ¨è§£æ"></textarea>
                    <small style="color: #6b7280; font-size: 14px; display: block; margin-top: 8px;">
                        ğŸ’¡ æç¤ºï¼šæ”¯æŒå¤šè¡Œæ‰¹é‡å¯¼å…¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå¹¶è·³è¿‡ç©ºè¡Œ
                    </small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ‰¹é‡å¯¼å…¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ä¸­è½¬çº¿è·¯æ¨¡æ€æ¡† -->
    <div id="transit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="transit-modal-title">æ·»åŠ ä¸­è½¬çº¿è·¯</h2>
                <button class="close-btn" onclick="closeTransitModal()">&times;</button>
            </div>
            <form id="transit-form" onsubmit="saveTransitProxy(event)">
                <div class="form-group">
                    <label>åç§° *</label>
                    <input type="text" name="name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç±»å‹ *</label>
                        <select name="type" required>
                            <option value="socks5" selected>socks5</option>
                            <option value="trojan">trojan</option>
                            <option value="http">http</option>
                            <option value="https">https</option>
                            <option value="ss">ss</option>
                            <option value="vmess">vmess</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>è·³è¿‡è¯ä¹¦éªŒè¯</label>
                        <select name="skip-cert-verify">
                            <option value="true" selected>æ˜¯</option>
                            <option value="false">å¦</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>æœåŠ¡å™¨ *</label>
                        <input type="text" name="server" required>
                    </div>
                    <div class="form-group">
                        <label>ç«¯å£ *</label>
                        <input type="text" name="port" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" name="username">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="text" name="password">
                    </div>
                </div>

                <div class="form-group">
                    <label>SNI</label>
                    <input type="text" name="sni">
                </div>

                <div class="form-group">
                    <label>UDP</label>
                    <select name="udp">
                        <option value="">æœªè®¾ç½®</option>
                        <option value="true">æ˜¯</option>
                        <option value="false">å¦</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å…¶ä»–å‚æ•° (JSON æ ¼å¼ï¼Œå¯é€‰)</label>
                    <textarea name="extra-params" rows="3" placeholder='{"key": "value"}' style="width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; font-family: 'Courier New', monospace;"></textarea>
                    <small style="color: #6b7280; font-size: 12px;">ä¾‹å¦‚: {"network": "tcp", "tls": true}</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTransitModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VM ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="vm-new-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ†• åˆ›å»ºæ–°è´¦å·</h2>
                <button class="close-btn" onclick="closeVMModal('new')">&times;</button>
            </div>
            <form onsubmit="executeVMNew(event)">
                <div class="form-group">
                    <label>è´¦å·åç§° *</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" name="name" id="vm-account-name-input" required placeholder="è‡ªåŠ¨ç”Ÿæˆ" readonly style="flex: 1; background-color: #f3f4f6;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="generateVMAccountName()" style="padding: 10px 16px; white-space: nowrap;">
                            ğŸ”„ é‡æ–°ç”Ÿæˆ
                        </button>
                    </div>
                    <small style="color: #6b7280; font-size: 12px;">æ ¼å¼ï¼šåº”ç”¨ç±»å‹_åœ°åŸŸ_è‡ªå¢æ•°ï¼ˆä¾‹å¦‚ï¼šVinted_GB_001ï¼‰</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>åº”ç”¨ç±»å‹ *</label>
                        <select name="app_type" id="vm-app-type-select" required onchange="generateVMAccountName()">
                            <option value="Vinted">Vinted</option>
                            <option value="Carousell">Carousell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>åœ°åŒº *</label>
                        <div style="display: flex; gap: 8px;">
                            <select name="region" id="vm-new-region-select" required style="flex: 1;" onchange="updateVMProxyNodes(); generateVMAccountName();">
                                <option value="">åŠ è½½ä¸­...</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="showRegionManageModal()" style="padding: 10px 16px; white-space: nowrap;">
                                âš™ï¸ ç®¡ç†
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>ä»£ç†èŠ‚ç‚¹åç§° *</label>
                    <select name="node" id="vm-new-node-select" required>
                        <option value="">è¯·å…ˆé€‰æ‹©åœ°åŒº</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeVMModal('new')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <div id="vm-load-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â™»ï¸ åŠ è½½è´¦å·</h2>
                <button class="close-btn" onclick="closeVMModal('load')">&times;</button>
            </div>
            <form onsubmit="executeVMLoad(event)">
                <div class="form-group">
                    <label>è´¦å·åç§° *</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select name="name" id="vm-load-account-select" required style="flex: 1; padding: 10px; border: 1px solid #e5e7eb; border-radius: 4px;">
                            <option value="">æ­£åœ¨åŠ è½½è´¦å·åˆ—è¡¨...</option>
                        </select>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="loadVMAccountList()" style="padding: 10px 16px; white-space: nowrap;">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <small style="color: #6b7280; font-size: 12px;">ä»è®¾å¤‡é…ç½®æ–‡ä»¶ç›®å½•è‡ªåŠ¨è·å–è´¦å·åˆ—è¡¨</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeVMModal('load')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åŠ è½½</button>
                </div>
            </form>
        </div>
    </div>

    <div id="vm-save-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’¾ ä¿å­˜è´¦å·</h2>
                <button class="close-btn" onclick="closeVMModal('save')">&times;</button>
            </div>
            <form onsubmit="executeVMSave(event)">
                <div class="form-group">
                    <label>è´¦å·åç§° (AccountName)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="vm-save-account-name" readonly style="flex: 1; background-color: #f3f4f6; cursor: not-allowed;" placeholder="æ­£åœ¨è·å–...">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="loadAccountNameForSave()" style="padding: 10px 16px; white-space: nowrap;">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <small style="color: #6b7280; font-size: 12px;">ä»è®¾å¤‡é…ç½®æ–‡ä»¶ä¸­è‡ªåŠ¨è·å–å½“å‰è´¦å·åç§°</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeVMModal('save')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- è·¯å¾„è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="path-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ æ–‡ä»¶è·¯å¾„è®¾ç½®</h2>
                <button class="close-btn" onclick="closePathSettingsModal()">&times;</button>
            </div>
            <form onsubmit="savePathSettings(event)">
                <div class="form-group">
                    <label>config.yaml æ–‡ä»¶è·¯å¾„</label>
                    <input type="text" id="config-file-path-input" style="width: 100%;" placeholder="ä¾‹å¦‚: D:\app_uploader\config.yaml">
                </div>
                <div class="form-group">
                    <label>vm.sh æ–‡ä»¶è·¯å¾„</label>
                    <input type="text" id="vm-script-path-input" style="width: 100%;" placeholder="ä¾‹å¦‚: D:\app_uploader\vm.sh">
                </div>
                <div class="form-group">
                    <label>adb å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„</label>
                    <input type="text" id="adb-path-input" style="width: 100%;" placeholder="ä¾‹å¦‚: C:\platform-tools\adb.exe æˆ– adb">
                </div>
                <div class="form-group">
                    <label>å¤šè´¦å·åŠ¨æ€é…ç½®æ–‡ä»¶è·¯å¾„</label>
                    <input type="text" id="vm-accounts-file-path-input" style="width: 100%;" placeholder="ä¾‹å¦‚: /data/local/tmp/multiapp_conf.txt">
                </div>
                <div class="form-group">
                    <label>VMæœºå‹é…ç½®è·¯å¾„</label>
                    <input type="text" id="vm-model-config-path-input" style="width: 100%;" placeholder="ä¾‹å¦‚: /data/local/tmp/vm_model_config.yaml">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePathSettingsModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘å¤‡æ³¨æ¨¡æ€æ¡† -->
    <div id="edit-remark-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ç¼–è¾‘è®¾å¤‡å¤‡æ³¨</h2>
                <button class="close-btn" onclick="closeEditRemarkModal()">&times;</button>
            </div>
            <form id="edit-remark-form" onsubmit="saveDeviceRemarkFromModal(event)">
                <div class="form-group">
                    <label>è®¾å¤‡ID</label>
                    <input type="text" id="edit-remark-device-id" readonly style="font-family: monospace; background: #f3f4f6; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="edit-remark-input" placeholder="è¯·è¾“å…¥å¤‡æ³¨" style="width: 100%;">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditRemarkModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åœ°åŒºç®¡ç†æ¨¡æ€æ¡† -->
    <div id="region-manage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸŒ åœ°åŒºç®¡ç†</h2>
                <button class="close-btn" onclick="closeRegionManageModal()">&times;</button>
            </div>
            
            <!-- æ·»åŠ åœ°åŒºè¡¨å• -->
            <div style="margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #374151;">æ·»åŠ æ–°åœ°åŒº</h3>
                <form onsubmit="addRegion(event)" style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">åœ°åŒºä»£ç  *</label>
                        <input type="text" name="code" id="region-code-input" required placeholder="ä¾‹å¦‚: US" maxlength="5" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 12px;">åœ°åŒºåç§° *</label>
                        <input type="text" name="name" id="region-name-input" required placeholder="ä¾‹å¦‚: ç¾å›½">
                    </div>
                    <button type="submit" class="btn btn-primary" style="height: fit-content;">æ·»åŠ </button>
                </form>
            </div>

            <!-- åœ°åŒºåˆ—è¡¨ -->
            <div>
                <h3 style="font-size: 16px; margin-bottom: 15px; color: #374151;">åœ°åŒºåˆ—è¡¨</h3>
                <div id="region-list-container" class="table-container">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>åœ°åŒºä»£ç </th>
                                <th>åœ°åŒºåç§°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="region-list-tbody">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: #6b7280;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeRegionManageModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let currentEditIndex = null;
        let currentEditProxyName = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„ä»£ç†çš„åŸå§‹åç§°
        let currentTransitEditIndex = null;
        let currentTransitEditName = null;
        let transitProxyNames = []; // ä¸­è½¬çº¿è·¯åç§°åˆ—è¡¨
        let vmEventSource = null; // Server-Sent Events è¿æ¥
        let regionsList = []; // åœ°åŒºåˆ—è¡¨

        // åŠ è½½ä»£ç†åˆ—è¡¨
        async function loadProxies() {
            const loading = document.getElementById('loading');
            const table = document.getElementById('proxy-table');
            const emptyState = document.getElementById('empty-state');
            const countEl = document.getElementById('proxy-count');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            emptyState.style.display = 'none';
            
            try {
                // è·å–å½“å‰è®¾å¤‡IDå¹¶æ·»åŠ åˆ°URL
                const deviceId = getCurrentDeviceId();
                const url = deviceId ? 
                    `/api/proxies?device_id=${encodeURIComponent(deviceId)}` : 
                    '/api/proxies';
                
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const proxies = result.data;
                    countEl.textContent = `å…± ${proxies.length} ä¸ªä»£ç†`;

                    // ä¿å­˜åˆ°åˆ†é¡µçŠ¶æ€
                    paginationState.proxies.allData = proxies;
                    paginationState.proxies.currentPage = 1;

                    // æ›´æ–°ä¸­è½¬çº¿è·¯è¿‡æ»¤å™¨é€‰é¡¹
                    updateDialerFilterOptions(proxies);

                    if (proxies.length === 0) {
                        emptyState.style.display = 'block';
                    } else {
                        // ä½¿ç”¨åˆ†é¡µæ¸²æŸ“
                        renderProxiesPage();
                        table.style.display = 'table';
                    }
                } else {
                    showAlert('error', 'åŠ è½½å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showAlert('error', 'åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // æ›´æ–°ä¸­è½¬çº¿è·¯è¿‡æ»¤å™¨é€‰é¡¹
        async function updateDialerFilterOptions(proxies) {
            const select = document.getElementById('proxy-dialer-filter');
            if (!select) return;
            
            // è·å–æ‰€æœ‰æœ‰æ•ˆçš„ä¸­è½¬çº¿è·¯åç§°ï¼ˆä»APIè·å–ï¼‰
            let validTransitNames = new Set();
            try {
                const response = await fetch(buildUrlWithDeviceId('/api/transit-proxies/names'));
                const result = await response.json();
                if (result.success) {
                    validTransitNames = new Set(result.data);
                }
            } catch (error) {
                console.error('è·å–ä¸­è½¬çº¿è·¯åˆ—è¡¨å¤±è´¥:', error);
            }
            
            // è·å–ä»£ç†ä¸­å®é™…ä½¿ç”¨çš„ä¸­è½¬çº¿è·¯åç§°ï¼ˆåªä¿ç•™æœ‰æ•ˆçš„ï¼‰
            const dialerSet = new Set();
            proxies.forEach(proxy => {
                const dialer = proxy['dialer-proxy'];
                if (dialer && validTransitNames.has(dialer)) {
                    dialerSet.add(dialer);
                }
            });
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = select.value;
            
            // é‡æ–°æ„å»ºé€‰é¡¹
            select.innerHTML = '<option value="">å…¨éƒ¨ä¸­è½¬çº¿è·¯</option>';
            
            // æ·»åŠ "æ— ä¸­è½¬"é€‰é¡¹
            const hasNoDialer = proxies.some(p => !p['dialer-proxy']);
            if (hasNoDialer) {
                const option = document.createElement('option');
                option.value = '__none__';
                option.textContent = 'æ— ä¸­è½¬çº¿è·¯';
                select.appendChild(option);
            }
            
            // æ·»åŠ ä¸­è½¬çº¿è·¯é€‰é¡¹ï¼ˆæŒ‰å­—æ¯æ’åºï¼‰
            Array.from(dialerSet).sort().forEach(dialer => {
                const option = document.createElement('option');
                option.value = dialer;
                option.textContent = `${dialer} (${proxies.filter(p => p['dialer-proxy'] === dialer).length})`;
                select.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœä»ç„¶æœ‰æ•ˆï¼‰
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            } else {
                // å¦‚æœä¹‹å‰é€‰ä¸­çš„å€¼æ— æ•ˆï¼Œé‡ç½®ä¸º"å…¨éƒ¨"
                select.value = '';
                paginationState.proxies.dialerFilter = '';
            }
        }

        // åˆ›å»ºä»£ç†è¡Œ
        function createProxyRow(proxy, index) {
            const row = document.createElement('tr');
            
            const typeBadge = getTypeBadge(proxy.type || 'unknown');
            const otherParams = getOtherParams(proxy);
            const dialerProxy = proxy['dialer-proxy'] || '-';
            const region = proxy.region || '-';

            row.innerHTML = `
                <td>${index}</td>
                <td><strong>${proxy.name || '-'}</strong></td>
                <td>${typeBadge}</td>
                <td><span class="badge badge-http">${region}</span></td>
                <td>${proxy.server || '-'}</td>
                <td>${proxy.port || '-'}</td>
                <td>${proxy.username || '-'}</td>
                <td>${dialerProxy}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="editProxy(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProxy(${index})">åˆ é™¤</button>
                    </div>
                </td>
            `;

            return row;
        }

        // è·å–ç±»å‹å¾½ç« 
        function getTypeBadge(type) {
            const badges = {
                'socks5': '<span class="badge badge-socks5">SOCKS5</span>',
                'trojan': '<span class="badge badge-trojan">Trojan</span>',
                'http': '<span class="badge badge-http">HTTP</span>',
                'https': '<span class="badge badge-http">HTTPS</span>',
                'ss': '<span class="badge badge-http">Shadowsocks</span>',
                'vmess': '<span class="badge badge-http">VMess</span>'
            };
            return badges[type] || `<span class="badge">${type}</span>`;
        }

        // è·å–å…¶ä»–å‚æ•°
        function getOtherParams(proxy) {
            const excludeKeys = ['name', 'type', 'server', 'port', 'username', 'password', 'region', '_index'];
            const other = {};
            for (const key in proxy) {
                if (!excludeKeys.includes(key) && proxy[key] !== null && proxy[key] !== undefined) {
                    other[key] = proxy[key];
                }
            }
            return Object.keys(other).length > 0 ? JSON.stringify(other, null, 2) : '-';
        }

        // åŠ è½½ä¸­è½¬çº¿è·¯åç§°åˆ—è¡¨
        async function loadTransitProxyNames() {
            try {
                const response = await fetch(buildUrlWithDeviceId('/api/transit-proxies/names'));
                const result = await response.json();
                if (result.success) {
                    transitProxyNames = result.data;
                    updateDialerProxySelect();
                }
            } catch (error) {
                console.error('åŠ è½½ä¸­è½¬çº¿è·¯åç§°å¤±è´¥:', error);
            }
        }

        // æ›´æ–°Dialer Proxyä¸‹æ‹‰é€‰æ‹©æ¡†
        function updateDialerProxySelect() {
            const select = document.getElementById('dialer-proxy-select');
            if (!select) return;
            
            // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼ˆæ— ï¼‰
            const firstOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            } else {
                select.innerHTML = '<option value="">æ— ï¼ˆä¸ä½¿ç”¨ä¸­è½¬ï¼‰</option>';
            }
            
            // æ·»åŠ ä¸­è½¬çº¿è·¯é€‰é¡¹
            transitProxyNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®æ ·å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.color = '#6b7280';
                btn.style.borderBottomColor = 'transparent';
            });
            
            // æ˜¾ç¤º/éšè—å†…å®¹
            document.getElementById('devices-tab').style.display = tabName === 'devices' ? 'block' : 'none';
            document.getElementById('proxies-tab').style.display = tabName === 'proxies' ? 'block' : 'none';
            document.getElementById('transit-tab').style.display = tabName === 'transit' ? 'block' : 'none';
            document.getElementById('vm-tab').style.display = tabName === 'vm' ? 'block' : 'none';
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾
            const tabButtons = document.querySelectorAll('.tab-btn');
            let activeBtn = null;
            if (tabName === 'devices') {
                activeBtn = tabButtons[0];
                loadDeviceConfigs(); // åŠ è½½è®¾å¤‡é…ç½®
                refreshDeviceList(); // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
            } else if (tabName === 'proxies') {
                activeBtn = tabButtons[1];
            } else if (tabName === 'transit') {
                activeBtn = tabButtons[2];
            } else if (tabName === 'vm') {
                activeBtn = tabButtons[3];
            }
            
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.color = '#667eea';
                activeBtn.style.borderBottomColor = '#667eea';
            }
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'devices') {
                refreshDeviceList();
            } else if (tabName === 'proxies') {
                loadProxies();
            } else if (tabName === 'transit') {
                loadTransitProxies();
            } else if (tabName === 'vm') {
                loadVMProxyNames();
                loadRegions();
            }
        }

        // æ›´æ–°ä»£ç†åœ°åŒºé€‰æ‹©æ¡†
        function updateProxyRegionSelect() {
            const select = document.getElementById('proxy-region-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°åŒº</option>';
            regionsList.forEach(region => {
                const option = document.createElement('option');
                option.value = region.code;
                option.textContent = `${region.code} (${region.name})`;
                select.appendChild(option);
            });
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        async function showAddModal() {
            currentEditIndex = null;
            currentEditProxyName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
            document.getElementById('modal-title').textContent = 'æ·»åŠ ä»£ç†';
            document.getElementById('proxy-form').reset();
            document.querySelector('select[name="type"]').value = 'socks5';
            document.querySelector('select[name="skip-cert-verify"]').value = 'true';
            document.querySelector('select[name="udp"]').value = 'true';  // è®¾ç½®UDPé»˜è®¤å€¼ä¸ºtrue
            
            // æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢æŒ‰é’®
            document.getElementById('proxy-mode-switch').style.display = 'block';
            
            // é»˜è®¤æ˜¾ç¤ºå•æ¡æ·»åŠ æ¨¡å¼
            switchProxyMode('single');
            
            // åŠ è½½ä¸­è½¬çº¿è·¯åç§°åˆ—è¡¨å’Œåœ°åŒºåˆ—è¡¨
            await Promise.all([loadTransitProxyNames(), loadRegions()]);
            updateProxyRegionSelect();
            updateBatchProxyRegionSelect();
            updateBatchDialerProxySelect();
            
            document.getElementById('proxy-modal').classList.add('active');
        }
        
        // åˆ‡æ¢ä»£ç†æ·»åŠ æ¨¡å¼ï¼ˆå•æ¡/æ‰¹é‡ï¼‰
        function switchProxyMode(mode) {
            const singleForm = document.getElementById('proxy-form');
            const batchForm = document.getElementById('proxy-batch-form');
            const modeBtns = document.querySelectorAll('.mode-btn');
            
            if (mode === 'single') {
                singleForm.style.display = 'block';
                batchForm.style.display = 'none';
                modeBtns[0].classList.add('active');
                modeBtns[1].classList.remove('active');
                modeBtns[0].style.background = 'white';
                modeBtns[1].style.background = 'transparent';
            } else {
                singleForm.style.display = 'none';
                batchForm.style.display = 'block';
                modeBtns[0].classList.remove('active');
                modeBtns[1].classList.add('active');
                modeBtns[0].style.background = 'transparent';
                modeBtns[1].style.background = 'white';
            }
        }
        
        // æ›´æ–°æ ¼å¼æç¤º
        function updateFormatHint() {
            const formatSelect = document.querySelector('select[name="format_type"]');
            const hintDiv = document.getElementById('format-hint');
            const format = formatSelect.value;
            
            const hints = {
                'format1': 'ç¤ºä¾‹: myuser:mypass:proxy.example.com:8080',
                'format2': 'ç¤ºä¾‹: proxy.example.com:8080:myuser:mypass',
                'format3': 'ç¤ºä¾‹: myuser:mypass@proxy.example.com:8080'
            };
            
            if (format && hints[format]) {
                hintDiv.textContent = hints[format];
                hintDiv.style.display = 'block';
            } else {
                hintDiv.style.display = 'none';
            }
        }
        
        // æ›´æ–°æ‰¹é‡å¯¼å…¥çš„åœ°åŒºé€‰æ‹©æ¡†
        function updateBatchProxyRegionSelect() {
            const select = document.getElementById('proxy-batch-region-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°åŒº</option>';
            regionsList.forEach(region => {
                const option = document.createElement('option');
                option.value = region.code;
                option.textContent = `${region.code} (${region.name})`;
                select.appendChild(option);
            });
        }
        
        // æ›´æ–°æ‰¹é‡å¯¼å…¥çš„ä¸­è½¬çº¿è·¯é€‰æ‹©æ¡†
        function updateBatchDialerProxySelect() {
            const select = document.getElementById('proxy-batch-dialer-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">æ— ï¼ˆä¸ä½¿ç”¨ä¸­è½¬ï¼‰</option>';
            transitProxyNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // ä¿å­˜æ‰¹é‡ä»£ç†
        async function saveBatchProxies(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const deviceId = getCurrentDeviceId();
            if (!deviceId) {
                showAlert('error', 'è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }

            if (!confirm(`é«˜å±æ“ä½œï¼šç¡®å®šæ‰¹é‡ä¿®æ”¹è¯¥è®¾å¤‡çš„ç½‘ç»œé…ç½®ï¼ˆä»£ç†çº¿è·¯ï¼‰å—ï¼Ÿ\n\nç›®æ ‡è®¾å¤‡ï¼š${formatDeviceLabel(deviceId)}`)) {
                return;
            }
            
            const data = {
                proxy_lines: formData.get('proxy_lines'),
                format_type: formData.get('format_type'),
                region: formData.get('region'),
                name_prefix: formData.get('name_prefix'),
                dialer_proxy: formData.get('dialer_proxy')
            };
            
            try {
                const response = await fetch(buildUrlWithDeviceId('/api/proxies/batch'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = formatOperationSummary('ä»£ç†æ‰¹é‡å¯¼å…¥', result, result.push_result);
                    if (result.message) {
                        message += `\n${result.message}`;
                    }
                    if (result.data && result.data.failed_lines && result.data.failed_lines.length > 0) {
                        message += '\n\nå¤±è´¥çš„è¡Œ:\n' + result.data.failed_lines.join('\n');
                    }
                    showAlert('success', message);
                    closeModal();
                    await loadProxies();
                } else {
                    showAlert('error', result.error || 'æ‰¹é‡å¯¼å…¥å¤±è´¥');
                }
            } catch (error) {
                showAlert('error', 'æ‰¹é‡å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘ä»£ç†
        async function editProxy(index) {
            try {
                const response = await fetch(buildUrlWithDeviceId('/api/proxies'));
                const result = await response.json();

                if (result.success && result.data[index]) {
                    const proxy = result.data[index];
                    // ä¿å­˜ä»£ç†çš„åŸå§‹åç§°ï¼ˆç”¨äºè¯†åˆ«è¦æ›´æ–°çš„ä»£ç†ï¼‰
                    currentEditProxyName = proxy.name;
                    currentEditIndex = index; // ä¿ç•™ä»¥å…¼å®¹æ—§ä»£ç 

                    // åŠ è½½ä¸­è½¬çº¿è·¯åç§°åˆ—è¡¨å’Œåœ°åŒºåˆ—è¡¨
                    await Promise.all([loadTransitProxyNames(), loadRegions()]);
                    updateProxyRegionSelect();
                    
                    // éšè—æ¨¡å¼åˆ‡æ¢æŒ‰é’®ï¼ˆç¼–è¾‘æ—¶åªèƒ½å•æ¡ï¼‰
                    document.getElementById('proxy-mode-switch').style.display = 'none';
                    document.getElementById('proxy-form').style.display = 'block';
                    document.getElementById('proxy-batch-form').style.display = 'none';

                    document.getElementById('modal-title').textContent = 'ç¼–è¾‘ä»£ç†';
                    document.querySelector('input[name="name"]').value = proxy.name || '';
                    document.querySelector('select[name="type"]').value = proxy.type || 'socks5';
                    document.querySelector('select[name="region"]').value = proxy.region || '';
                    document.querySelector('input[name="server"]').value = proxy.server || '';
                    document.querySelector('input[name="port"]').value = proxy.port || '';
                    document.querySelector('input[name="username"]').value = proxy.username || '';
                    document.querySelector('input[name="password"]').value = proxy.password || '';
                    document.querySelector('input[name="sni"]').value = proxy.sni || '';
                    document.querySelector('select[name="skip-cert-verify"]').value = String(proxy['skip-cert-verify'] !== false);
                    document.querySelector('select[name="udp"]').value = proxy.udp !== undefined ? String(proxy.udp) : '';
                    document.querySelector('select[name="dialer-proxy"]').value = proxy['dialer-proxy'] || '';

                    // å¤„ç†å…¶ä»–å‚æ•°
                    const excludeKeys = ['name', 'type', 'server', 'port', 'username', 'password', 'sni', 'skip-cert-verify', 'udp', 'dialer-proxy', 'region', '_index'];
                    const extra = {};
                    for (const key in proxy) {
                        if (!excludeKeys.includes(key)) {
                            extra[key] = proxy[key];
                        }
                    }
                    document.querySelector('textarea[name="extra-params"]').value = Object.keys(extra).length > 0 ? JSON.stringify(extra, null, 2) : '';

                    document.getElementById('proxy-modal').classList.add('active');
                }
            } catch (error) {
                showAlert('error', 'åŠ è½½ä»£ç†ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜ä»£ç†
        async function saveProxy(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const deviceId = getCurrentDeviceId();
            if (!deviceId) {
                showAlert('error', 'è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }

            const actionText = currentEditProxyName !== null ? 'ç¼–è¾‘' : 'æ–°å¢';
            if (!confirm(`é«˜å±æ“ä½œï¼šæ˜¯å¦${actionText}è¯¥è®¾å¤‡çš„ç½‘ç»œé…ç½®ï¼ˆä»£ç†çº¿è·¯ï¼‰ï¼Ÿ\n\nç›®æ ‡è®¾å¤‡ï¼š${formatDeviceLabel(deviceId)}`)) {
                return;
            }

            const data = {
                name: formData.get('name'),
                type: formData.get('type'),
                server: formData.get('server'),
                port: formData.get('port'),
                region: formData.get('region'),  // æ·»åŠ  region å­—æ®µ
                'skip-cert-verify': formData.get('skip-cert-verify') === 'true'
            };

            if (formData.get('username')) data.username = formData.get('username');
            if (formData.get('password')) data.password = formData.get('password');
            if (formData.get('sni')) data.sni = formData.get('sni');
            if (formData.get('udp')) data.udp = formData.get('udp') === 'true';
            // æ€»æ˜¯å‘é€dialer-proxyå­—æ®µï¼Œå³ä½¿ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆè¡¨ç¤ºä¸ä½¿ç”¨ä¸­è½¬ï¼‰
            data['dialer-proxy'] = formData.get('dialer-proxy') || '';

            // è§£æå…¶ä»–å‚æ•°
            const extraParams = formData.get('extra-params');
            if (extraParams) {
                try {
                    const extra = JSON.parse(extraParams);
                    Object.assign(data, extra);
                } catch (e) {
                    showAlert('error', 'å…¶ä»–å‚æ•°æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON');
                    return;
                }
            }

            try {
                let url, method;
                if (currentEditProxyName !== null) {
                    // ç¼–è¾‘æ¨¡å¼ï¼šä½¿ç”¨ä»£ç†åç§°ï¼ˆè€Œä¸æ˜¯ç´¢å¼•ï¼‰
                    url = `/api/proxies/by-name/${encodeURIComponent(currentEditProxyName)}`;
                    method = 'PUT';
                } else {
                    // æ–°å¢æ¨¡å¼
                    url = '/api/proxies';
                    method = 'POST';
                }

                url = buildUrlWithDeviceId(url);

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    const actionLabel = currentEditProxyName !== null ? 'ä»£ç†æ›´æ–°' : 'ä»£ç†æ–°å¢';
                    showAlert('success', formatOperationSummary(actionLabel, result, result.push_result));
                    closeModal();
                    loadProxies();
                } else {
                    showAlert('error', 'æ“ä½œå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showAlert('error', 'æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ä»£ç†
        async function deleteProxy(index) {
            const deviceId = getCurrentDeviceId();
            if (!deviceId) {
                showAlert('error', 'è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            if (!confirm(`é«˜å±æ“ä½œï¼šç¡®å®šåˆ é™¤è¯¥è®¾å¤‡çš„ç½‘ç»œé…ç½®ä¸­çš„ä»£ç†çº¿è·¯å—ï¼Ÿ\n\nç›®æ ‡è®¾å¤‡ï¼š${formatDeviceLabel(deviceId)}`)) {
                return;
            }

            try {
                // å…ˆè·å–ä»£ç†åˆ—è¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„ä»£ç†åç§°
                const listResponse = await fetch(buildUrlWithDeviceId('/api/proxies'));
                const listResult = await listResponse.json();
                
                if (!listResult.success || !listResult.data[index]) {
                    showAlert('error', 'æœªæ‰¾åˆ°è¦åˆ é™¤çš„ä»£ç†');
                    return;
                }
                
                const proxyName = listResult.data[index].name;
                
                // ä½¿ç”¨ä»£ç†åç§°åˆ é™¤
                const url = buildUrlWithDeviceId(`/api/proxies/by-name/${encodeURIComponent(proxyName)}`);
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', formatOperationSummary('ä»£ç†åˆ é™¤', result, result.push_result));
                    await loadProxies();
                } else {
                    showAlert('error', 'åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showAlert('error', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('proxy-modal').classList.remove('active');
            currentEditIndex = null;
            currentEditProxyName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        function formatOperationSummary(actionLabel, result, pushResult) {
            const opStatus = result && result.success ? 'æˆåŠŸ' : 'å¤±è´¥';

            let pushStatus = 'æœªæ¨é€';
            let extra = '';

            if (pushResult) {
                pushStatus = pushResult.success ? 'æˆåŠŸ' : 'å¤±è´¥';

                if (!pushResult.success) {
                    const msg = (pushResult.message || '').trim();
                    if (msg.includes('è®¾å¤‡ä¸åœ¨çº¿')) {
                        extra = 'ï¼Œè®¾å¤‡ä¸åœ¨çº¿';
                    } else if (msg) {
                        extra = `ï¼Œ${msg.replace(/^æ¨é€å¤±è´¥[:ï¼š]?/, '').trim()}`;
                    }
                }
            }

            return `${actionLabel}çŠ¶æ€ã€${opStatus}ã€‘ï¼Œadb æ¨é€çŠ¶æ€ï¼šã€${pushStatus}ã€‘${extra}`;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('proxy-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ==================== ä¸­è½¬çº¿è·¯ç®¡ç† ====================
        
        // åŠ è½½ä¸­è½¬çº¿è·¯åˆ—è¡¨
        async function loadTransitProxies() {
            const loading = document.getElementById('transit-loading');
            const table = document.getElementById('transit-table');
            const emptyState = document.getElementById('transit-empty-state');
            const countEl = document.getElementById('transit-count');

            loading.style.display = 'block';
            table.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                // è·å–å½“å‰è®¾å¤‡IDå¹¶æ·»åŠ åˆ°URL
                const deviceId = getCurrentDeviceId();
                const url = deviceId ? 
                    `/api/transit-proxies?device_id=${encodeURIComponent(deviceId)}` : 
                    '/api/transit-proxies';
                
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    const proxies = result.data;
                    countEl.textContent = `å…± ${proxies.length} ä¸ªä¸­è½¬çº¿è·¯`;

                    // ä¿å­˜åˆ°åˆ†é¡µçŠ¶æ€
                    paginationState.transit.allData = proxies;
                    paginationState.transit.currentPage = 1;

                    if (proxies.length === 0) {
                        emptyState.style.display = 'block';
                    } else {
                        // ä½¿ç”¨åˆ†é¡µæ¸²æŸ“
                        renderTransitPage();
                        table.style.display = 'table';
                    }
                } else {
                    showTransitAlert('error', 'åŠ è½½å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showTransitAlert('error', 'åŠ è½½å¤±è´¥: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        // åˆ›å»ºä¸­è½¬çº¿è·¯è¡Œ
        function createTransitRow(proxy, index) {
            const row = document.createElement('tr');
            
            const typeBadge = getTypeBadge(proxy.type || 'unknown');
            const otherParams = getOtherParams(proxy);

            row.innerHTML = `
                <td>${index}</td>
                <td><strong>${proxy.name || '-'}</strong></td>
                <td>${typeBadge}</td>
                <td>${proxy.server || '-'}</td>
                <td>${proxy.port || '-'}</td>
                <td>${proxy.username || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-success" onclick="editTransitProxy(${index})">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTransitProxy(${index})">åˆ é™¤</button>
                    </div>
                </td>
            `;

            return row;
        }

        // æ˜¾ç¤ºæ·»åŠ ä¸­è½¬çº¿è·¯æ¨¡æ€æ¡†
        function showAddTransitModal() {
            currentTransitEditIndex = null;
            currentTransitEditName = null;
            document.getElementById('transit-modal-title').textContent = 'æ·»åŠ ä¸­è½¬çº¿è·¯';
            document.getElementById('transit-form').reset();
            document.querySelector('#transit-form select[name="type"]').value = 'socks5';
            document.querySelector('#transit-form select[name="skip-cert-verify"]').value = 'true';
            const nameInput = document.querySelector('#transit-form input[name="name"]');
            if (nameInput) {
                nameInput.readOnly = false;
                nameInput.style.backgroundColor = '';
                nameInput.style.cursor = '';
            }
            document.getElementById('transit-modal').classList.add('active');
        }

        // ç¼–è¾‘ä¸­è½¬çº¿è·¯
        async function editTransitProxy(index) {
            try {
                const response = await fetch(buildUrlWithDeviceId('/api/transit-proxies'));
                const result = await response.json();

                if (result.success && result.data[index]) {
                    const proxy = result.data[index];
                    currentTransitEditIndex = index;
                    currentTransitEditName = proxy.name || '';

                    document.getElementById('transit-modal-title').textContent = 'ç¼–è¾‘ä¸­è½¬çº¿è·¯';
                    const nameInput = document.querySelector('#transit-form input[name="name"]');
                    if (nameInput) {
                        nameInput.value = proxy.name || '';
                        nameInput.readOnly = true;
                        nameInput.style.backgroundColor = '#f3f4f6';
                        nameInput.style.cursor = 'not-allowed';
                    }
                    document.querySelector('#transit-form select[name="type"]').value = proxy.type || 'socks5';
                    document.querySelector('#transit-form input[name="server"]').value = proxy.server || '';
                    document.querySelector('#transit-form input[name="port"]').value = proxy.port || '';
                    document.querySelector('#transit-form input[name="username"]').value = proxy.username || '';
                    document.querySelector('#transit-form input[name="password"]').value = proxy.password || '';
                    document.querySelector('#transit-form input[name="sni"]').value = proxy.sni || '';
                    document.querySelector('#transit-form select[name="skip-cert-verify"]').value = String(proxy['skip-cert-verify'] !== false);
                    document.querySelector('#transit-form select[name="udp"]').value = proxy.udp !== undefined ? String(proxy.udp) : '';

                    // å¤„ç†å…¶ä»–å‚æ•°
                    const excludeKeys = ['name', 'type', 'server', 'port', 'username', 'password', 'sni', 'skip-cert-verify', 'udp', '_index'];
                    const extra = {};
                    for (const key in proxy) {
                        if (!excludeKeys.includes(key)) {
                            extra[key] = proxy[key];
                        }
                    }
                    document.querySelector('#transit-form textarea[name="extra-params"]').value = Object.keys(extra).length > 0 ? JSON.stringify(extra, null, 2) : '';

                    document.getElementById('transit-modal').classList.add('active');
                }
            } catch (error) {
                showTransitAlert('error', 'åŠ è½½ä¸­è½¬çº¿è·¯ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜ä¸­è½¬çº¿è·¯
        async function saveTransitProxy(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const deviceId = getCurrentDeviceId();
            if (!deviceId) {
                showTransitAlert('error', 'è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }

            const actionText = currentTransitEditIndex !== null ? 'ç¼–è¾‘' : 'æ–°å¢';
            if (!confirm(`é«˜å±æ“ä½œï¼šæ˜¯å¦${actionText}è¯¥è®¾å¤‡çš„ç½‘ç»œé…ç½®ï¼ˆä¸­è½¬çº¿è·¯ï¼‰ï¼Ÿ\n\nç›®æ ‡è®¾å¤‡ï¼š${formatDeviceLabel(deviceId)}`)) {
                return;
            }

            const data = {
                name: formData.get('name'),
                type: formData.get('type'),
                server: formData.get('server'),
                port: formData.get('port'),
                'skip-cert-verify': formData.get('skip-cert-verify') === 'true'
            };

            // ç¼–è¾‘æ¨¡å¼ï¼šç¦æ­¢ä¿®æ”¹åç§°ï¼Œå¼ºåˆ¶ä½¿ç”¨åŸåç§°
            if (currentTransitEditIndex !== null) {
                data.name = currentTransitEditName || data.name;
            }

            if (formData.get('username')) data.username = formData.get('username');
            if (formData.get('password')) data.password = formData.get('password');
            if (formData.get('sni')) data.sni = formData.get('sni');
            if (formData.get('udp')) data.udp = formData.get('udp') === 'true';

            // è§£æå…¶ä»–å‚æ•°
            const extraParams = formData.get('extra-params');
            if (extraParams) {
                try {
                    const extra = JSON.parse(extraParams);
                    Object.assign(data, extra);
                } catch (e) {
                    showTransitAlert('error', 'å…¶ä»–å‚æ•°æ ¼å¼é”™è¯¯ï¼Œå¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON');
                    return;
                }
            }

            try {
                const baseUrl = currentTransitEditIndex !== null 
                    ? `/api/transit-proxies/${currentTransitEditIndex}` 
                    : '/api/transit-proxies';
                const url = buildUrlWithDeviceId(baseUrl);
                const method = currentTransitEditIndex !== null ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    const actionLabel = currentTransitEditIndex !== null ? 'çº¿è·¯æ›´æ–°' : 'çº¿è·¯æ–°å¢';
                    showTransitAlert('success', formatOperationSummary(actionLabel, result, result.push_result));
                    closeTransitModal();
                    await loadTransitProxies();
                    // åˆ·æ–°ä»£ç†é¡µé¢çš„ä¸­è½¬çº¿è·¯åç§°åˆ—è¡¨å’Œè¿‡æ»¤å™¨
                    await loadTransitProxyNames();
                    // åˆ·æ–°ä»£ç†åˆ—è¡¨ä»¥æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹
                    if (paginationState.proxies.allData.length > 0) {
                        await updateDialerFilterOptions(paginationState.proxies.allData);
                    }
                } else {
                    showTransitAlert('error', 'æ“ä½œå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showTransitAlert('error', 'æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ä¸­è½¬çº¿è·¯
        async function deleteTransitProxy(index) {
            const deviceId = getCurrentDeviceId();
            if (!deviceId) {
                showTransitAlert('error', 'è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            if (!confirm(`é«˜å±æ“ä½œï¼šç¡®å®šåˆ é™¤è¯¥è®¾å¤‡çš„ç½‘ç»œé…ç½®ä¸­çš„ä¸­è½¬çº¿è·¯å—ï¼Ÿ\n\nç›®æ ‡è®¾å¤‡ï¼š${formatDeviceLabel(deviceId)}\n\nå¦‚æœè¯¥çº¿è·¯è¢«å…¶ä»–ä»£ç†ä½¿ç”¨ï¼Œå°†æ— æ³•åˆ é™¤ã€‚`)) {
                return;
            }

            try {
                const url = buildUrlWithDeviceId(`/api/transit-proxies/${index}`);
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showTransitAlert('success', formatOperationSummary('çº¿è·¯åˆ é™¤', result, result.push_result));
                    await loadTransitProxies();
                    // åˆ·æ–°ä»£ç†é¡µé¢çš„ä¸­è½¬çº¿è·¯åç§°åˆ—è¡¨å’Œè¿‡æ»¤å™¨
                    await loadTransitProxyNames();
                    // åˆ·æ–°ä»£ç†åˆ—è¡¨ä»¥æ›´æ–°è¿‡æ»¤å™¨é€‰é¡¹
                    if (paginationState.proxies.allData.length > 0) {
                        await updateDialerFilterOptions(paginationState.proxies.allData);
                    }
                } else {
                    showTransitAlert('error', 'åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showTransitAlert('error', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­ä¸­è½¬çº¿è·¯æ¨¡æ€æ¡†
        function closeTransitModal() {
            document.getElementById('transit-modal').classList.remove('active');
            currentTransitEditIndex = null;
            currentTransitEditName = null;
            const nameInput = document.querySelector('#transit-form input[name="name"]');
            if (nameInput) {
                nameInput.readOnly = false;
                nameInput.style.backgroundColor = '';
                nameInput.style.cursor = '';
            }
        }

        // æ˜¾ç¤ºä¸­è½¬çº¿è·¯æç¤ºä¿¡æ¯
        function showTransitAlert(type, message) {
            const container = document.getElementById('transit-alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // ç‚¹å‡»ä¸­è½¬çº¿è·¯æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('transit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTransitModal();
            }
        });

        // ==================== VM ç®¡ç†åŠŸèƒ½ ====================
        
        // åŠ è½½ä»£ç†åç§°åˆ—è¡¨ï¼ˆç”¨äºåˆ›å»ºæ–°è´¦å·æ—¶é€‰æ‹©èŠ‚ç‚¹ï¼‰
        async function loadVMProxyNames(region = '') {
            try {
                const url = region 
                    ? `/api/vm/proxy-names?region=${encodeURIComponent(region)}`
                    : '/api/vm/proxy-names';
                const response = await fetch(url);
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('vm-new-node-select');
                    if (select) {
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©ä»£ç†èŠ‚ç‚¹</option>';
                        if (result.data.length === 0) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = region ? 'è¯¥åœ°åŒºæš‚æ— å¯ç”¨ä»£ç†' : 'æš‚æ— å¯ç”¨ä»£ç†';
                            option.disabled = true;
                            select.appendChild(option);
                        } else {
                            result.data.forEach(name => {
                                const option = document.createElement('option');
                                option.value = name;
                                option.textContent = name;
                                select.appendChild(option);
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä»£ç†åç§°å¤±è´¥:', error);
            }
        }

        // æ›´æ–°VMä»£ç†èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæ ¹æ®é€‰æ‹©çš„regionï¼‰
        function updateVMProxyNodes() {
            const regionSelect = document.getElementById('vm-new-region-select');
            const selectedRegion = regionSelect ? regionSelect.value : '';
            if (selectedRegion) {
                loadVMProxyNames(selectedRegion);
            } else {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©regionï¼Œæ¸…ç©ºä»£ç†èŠ‚ç‚¹åˆ—è¡¨
                const nodeSelect = document.getElementById('vm-new-node-select');
                if (nodeSelect) {
                    nodeSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©åœ°åŒº</option>';
                }
            }
        }

        // åŠ è½½åœ°åŒºåˆ—è¡¨
        async function loadRegions() {
            try {
                const response = await fetch('/api/regions');
                const result = await response.json();
                if (result.success) {
                    regionsList = result.data;
                    updateRegionSelect();  // æ›´æ–°VMåˆ›å»ºè¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©æ¡†
                    updateProxyRegionSelect();  // æ›´æ–°ä»£ç†è¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©æ¡†
                    updateRegionList();  // æ›´æ–°åœ°åŒºç®¡ç†åˆ—è¡¨
                }
            } catch (error) {
                console.error('åŠ è½½åœ°åŒºåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åœ°åŒºä¸‹æ‹‰é€‰æ‹©æ¡†
        function updateRegionSelect() {
            const select = document.getElementById('vm-new-region-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åœ°åŒº</option>';
            regionsList.forEach(region => {
                const option = document.createElement('option');
                option.value = region.code;
                option.textContent = `${region.code} (${region.name})`;
                select.appendChild(option);
            });
        }

        // æ›´æ–°åœ°åŒºåˆ—è¡¨æ˜¾ç¤º
        function updateRegionList() {
            const tbody = document.getElementById('region-list-tbody');
            if (!tbody) return;
            
            if (regionsList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— åœ°åŒºé…ç½®</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            regionsList.forEach(region => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${region.code}</strong></td>
                    <td>${region.name}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteRegion('${region.code}')">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ˜¾ç¤ºåœ°åŒºç®¡ç†æ¨¡æ€æ¡†
        async function showRegionManageModal() {
            await loadRegions();
            document.getElementById('region-manage-modal').classList.add('active');
        }

        // å…³é—­åœ°åŒºç®¡ç†æ¨¡æ€æ¡†
        function closeRegionManageModal() {
            document.getElementById('region-manage-modal').classList.remove('active');
        }

        // æ·»åŠ åœ°åŒº
        async function addRegion(event) {
            event.preventDefault();
            const code = document.getElementById('region-code-input').value.trim().toUpperCase();
            const name = document.getElementById('region-name-input').value.trim();
            
            if (!code || !name) {
                showVMAlert('error', 'è¯·å¡«å†™åœ°åŒºä»£ç å’Œåç§°');
                return;
            }
            
            try {
                const response = await fetch('/api/regions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code, name })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showVMAlert('success', result.message);
                    document.getElementById('region-code-input').value = '';
                    document.getElementById('region-name-input').value = '';
                    await loadRegions();
                    // æ›´æ–°ä»£ç†è¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©æ¡†
                    updateProxyRegionSelect();
                    // æ›´æ–° VM åˆ›å»ºè¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©æ¡†
                    updateRegionSelect();
                } else {
                    showVMAlert('error', 'æ·»åŠ å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showVMAlert('error', 'æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤åœ°åŒº
        async function deleteRegion(code) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åœ°åŒº "${code}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/regions/${code}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showVMAlert('success', result.message);
                    await loadRegions();
                    // æ›´æ–°ä»£ç†è¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©æ¡†
                    updateProxyRegionSelect();
                    // æ›´æ–° VM åˆ›å»ºè¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©æ¡†
                    updateRegionSelect();
                } else {
                    showVMAlert('error', 'åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showVMAlert('error', 'åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç”ŸæˆVMè´¦å·åç§°
        async function generateVMAccountName() {
            const appType = document.getElementById('vm-app-type-select')?.value || 'Vinted';
            const region = document.getElementById('vm-new-region-select')?.value || '';
            
            if (!appType || !region) {
                // å¦‚æœåº”ç”¨ç±»å‹æˆ–åœ°åŒºæœªé€‰æ‹©ï¼Œæ¸…ç©ºè´¦å·åç§°
                const nameInput = document.getElementById('vm-account-name-input');
                if (nameInput) {
                    nameInput.value = '';
                }
                return;
            }
            
            try {
                const response = await fetch(`/api/vm/generate-account-name?app_type=${encodeURIComponent(appType)}&region=${encodeURIComponent(region)}`);
                const result = await response.json();
                
                if (result.success) {
                    const nameInput = document.getElementById('vm-account-name-input');
                    if (nameInput) {
                        nameInput.value = result.data;
                    }
                } else {
                    console.error('ç”Ÿæˆè´¦å·åç§°å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('ç”Ÿæˆè´¦å·åç§°å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºæ–°è´¦å·æ¨¡æ€æ¡†
        async function showVMNewModal() {
            await loadRegions();
            // ä¸ç«‹å³åŠ è½½ä»£ç†èŠ‚ç‚¹ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©regionåå†åŠ è½½
            const nodeSelect = document.getElementById('vm-new-node-select');
            if (nodeSelect) {
                nodeSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©åœ°åŒº</option>';
            }
            // é‡ç½®è´¦å·åç§°è¾“å…¥æ¡†
            const nameInput = document.getElementById('vm-account-name-input');
            if (nameInput) {
                nameInput.value = '';
            }
            document.getElementById('vm-new-modal').classList.add('active');
        }

        // æ˜¾ç¤ºåŠ è½½è´¦å·æ¨¡æ€æ¡†
        async function showVMLoadModal() {
            document.getElementById('vm-load-modal').classList.add('active');
            // æ‰“å¼€æ¨¡æ€æ¡†æ—¶è‡ªåŠ¨åŠ è½½è´¦å·åˆ—è¡¨
            await loadVMAccountList();
        }
        
        // åŠ è½½VMè´¦å·åˆ—è¡¨
        async function loadVMAccountList() {
            const select = document.getElementById('vm-load-account-select');
            select.innerHTML = '<option value="">æ­£åœ¨åŠ è½½è´¦å·åˆ—è¡¨...</option>';
            select.disabled = true;
            
            try {
                const response = await fetch('/api/vm/account-list');
                const result = await response.json();
                
                select.innerHTML = '';
                select.disabled = false;
                
                if (result.success && result.data && result.data.length > 0) {
                    const accounts = result.data;
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦å·</option>';
                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">æš‚æ— è´¦å·ï¼Œè¯·å…ˆåˆ›å»ºè´¦å·</option>';
                    showVMAlert('warning', 'æœªæ‰¾åˆ°è´¦å·åˆ—è¡¨ï¼Œè¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥ä¸”å·²åˆ›å»ºè´¦å·');
                }
            } catch (error) {
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                select.disabled = false;
                showVMAlert('error', 'åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºä¿å­˜è´¦å·æ¨¡æ€æ¡†
        async function showVMSaveModal() {
            document.getElementById('vm-save-modal').classList.add('active');
            // æ‰“å¼€æ¨¡æ€æ¡†æ—¶è‡ªåŠ¨è·å–AccountName
            await loadAccountNameForSave();
        }
        
        // åŠ è½½AccountNameç”¨äºä¿å­˜
        async function loadAccountNameForSave() {
            const accountNameInput = document.getElementById('vm-save-account-name');
            accountNameInput.value = '';
            accountNameInput.placeholder = 'æ­£åœ¨è·å–...';
            
            try {
                const response = await fetch('/api/vm/get-config-value?field_name=AccountName');
                const result = await response.json();
                
                if (result.success && result.data && result.data.value) {
                    accountNameInput.value = result.data.value;
                    accountNameInput.placeholder = 'å·²è·å–è´¦å·åç§°';
                } else {
                    accountNameInput.value = '';
                    accountNameInput.placeholder = 'æœªæ‰¾åˆ°AccountNameï¼Œè¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥ä¸”å·²åˆ›å»º/åŠ è½½è´¦å·';
                    showVMAlert('warning', 'æ— æ³•è·å–AccountNameï¼Œè¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥ä¸”å·²åˆ›å»º/åŠ è½½è´¦å·');
                }
            } catch (error) {
                accountNameInput.value = '';
                accountNameInput.placeholder = 'è·å–å¤±è´¥: ' + error.message;
                showVMAlert('error', 'è·å–AccountNameå¤±è´¥: ' + error.message);
            }
        }

        // å…³é—­ VM æ¨¡æ€æ¡†
        function closeVMModal(type) {
            document.getElementById(`vm-${type}-modal`).classList.remove('active');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearVMLog() {
            const logContainer = document.getElementById('vm-log-container');
            logContainer.innerHTML = '<div style="color: #6b7280;">ç­‰å¾…æ“ä½œ...</div>';
        }

        // æ·»åŠ æ—¥å¿—åˆ°æ˜¾ç¤ºåŒºåŸŸ
        function appendVMLog(message) {
            const logContainer = document.getElementById('vm-log-container');
            const timestamp = new Date().toLocaleTimeString();
            
            // ç§»é™¤"ç­‰å¾…æ“ä½œ"æç¤º
            if (logContainer.innerHTML.includes('ç­‰å¾…æ“ä½œ')) {
                logContainer.innerHTML = '';
            }
            
            // åˆ›å»ºæ—¥å¿—è¡Œ
            const logLine = document.createElement('div');
            logLine.style.marginBottom = '4px';
            logLine.style.wordBreak = 'break-word';
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®é¢œè‰²
            if (message.includes('âŒ') || message.includes('é”™è¯¯')) {
                logLine.style.color = '#f87171'; // çº¢è‰²
            } else if (message.includes('âœ…') || message.includes('å®Œæˆ')) {
                logLine.style.color = '#34d399'; // ç»¿è‰²
            } else if (message.includes('âš ') || message.includes('è­¦å‘Š')) {
                logLine.style.color = '#fbbf24'; // é»„è‰²
            } else {
                logLine.style.color = '#d4d4d4'; // é»˜è®¤ç™½è‰²
            }
            
            logLine.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logLine);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ‰§è¡Œåˆ›å»ºæ–°è´¦å·
        async function executeVMNew(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                app_type: formData.get('app_type'),
                region: formData.get('region'),
                node: formData.get('node')
            };
            
            if (!data.name || !data.node) {
                showVMAlert('error', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
                return;
            }
            
            closeVMModal('new');
            clearVMLog();
            appendVMLog(`ğŸ†• å¼€å§‹åˆ›å»ºæ–°è´¦å·: ${data.name} (${data.app_type}, ${data.region}, ${data.node})`);
            
            try {
                const response = await fetch('/api/vm/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    appendVMLog(`âŒ é”™è¯¯: ${error.error || 'è¯·æ±‚å¤±è´¥'}`);
                    return;
                }
                
                // ä½¿ç”¨ EventSource æ¥æ”¶æµå¼æ—¥å¿—
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6);
                            if (message.trim()) {
                                appendVMLog(message);
                            }
                        }
                    }
                }
            } catch (error) {
                appendVMLog(`âŒ æ‰§è¡Œå¤±è´¥: ${error.message}`);
            }
        }

        // æ‰§è¡ŒåŠ è½½è´¦å·
        async function executeVMLoad(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const name = formData.get('name');
            
            if (!name) {
                showVMAlert('error', 'è¯·è¾“å…¥è´¦å·åç§°');
                return;
            }
            
            closeVMModal('load');
            clearVMLog();
            appendVMLog(`â™»ï¸ å¼€å§‹åŠ è½½è´¦å·: ${name}`);
            
            try {
                const response = await fetch('/api/vm/load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    appendVMLog(`âŒ é”™è¯¯: ${error.error || 'è¯·æ±‚å¤±è´¥'}`);
                    return;
                }
                
                // ä½¿ç”¨ EventSource æ¥æ”¶æµå¼æ—¥å¿—
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6);
                            if (message.trim()) {
                                appendVMLog(message);
                            }
                        }
                    }
                }
            } catch (error) {
                appendVMLog(`âŒ æ‰§è¡Œå¤±è´¥: ${error.message}`);
            }
        }

        // æ‰§è¡Œä¿å­˜è´¦å·
        async function executeVMSave(event) {
            event.preventDefault();
            
            const accountNameInput = document.getElementById('vm-save-account-name');
            const accountName = accountNameInput.value.trim();
            
            if (!accountName) {
                showVMAlert('error', 'æ— æ³•è·å–è´¦å·åç§°ï¼Œè¯·å…ˆåˆ·æ–°è·å–AccountName');
                return;
            }
            
            closeVMModal('save');
            clearVMLog();
            appendVMLog(`ğŸ’¾ å¼€å§‹ä¿å­˜è´¦å·: ${accountName}`);
            appendVMLog(`ğŸ“ è´¦å·åç§° (AccountName): ${accountName}`);
            
            try {
                // ä¸å‘é€nameå‚æ•°ï¼Œè®©åç«¯è‡ªåŠ¨ä»è®¾å¤‡é…ç½®æ–‡ä»¶è·å–
                const response = await fetch('/api/vm/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})  // ä¸å‘é€nameï¼Œåç«¯ä¼šè‡ªåŠ¨è·å–
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    appendVMLog(`âŒ é”™è¯¯: ${error.error || 'è¯·æ±‚å¤±è´¥'}`);
                    return;
                }
                
                // ä½¿ç”¨ EventSource æ¥æ”¶æµå¼æ—¥å¿—
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6);
                            if (message.trim()) {
                                appendVMLog(message);
                            }
                        }
                    }
                }
            } catch (error) {
                appendVMLog(`âŒ æ‰§è¡Œå¤±è´¥: ${error.message}`);
            }
        }

        // æ˜¾ç¤º VM æç¤ºä¿¡æ¯
        function showVMAlert(type, message) {
            const container = document.getElementById('vm-alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // ç‚¹å‡» VM æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('vm-new-modal').addEventListener('click', function(e) {
            if (e.target === this) closeVMModal('new');
        });
        document.getElementById('vm-load-modal').addEventListener('click', function(e) {
            if (e.target === this) closeVMModal('load');
        });
        document.getElementById('vm-save-modal').addEventListener('click', function(e) {
            if (e.target === this) closeVMModal('save');
        });
        document.getElementById('region-manage-modal').addEventListener('click', function(e) {
            if (e.target === this) closeRegionManageModal();
        });
        document.getElementById('path-settings-modal').addEventListener('click', function(e) {
            if (e.target === this) closePathSettingsModal();
        });
        document.getElementById('edit-remark-modal').addEventListener('click', function(e) {
            if (e.target === this) closeEditRemarkModal();
        });

        // ==================== è·¯å¾„è®¾ç½®åŠŸèƒ½ ====================
        
        // æ˜¾ç¤ºè·¯å¾„è®¾ç½®æ¨¡æ€æ¡†
        async function showPathSettingsModal() {
            try {
                const response = await fetch('/api/settings/paths');
                const result = await response.json();
                if (result.success) {
                    document.getElementById('config-file-path-input').value = result.data.config_file_path || '';
                    document.getElementById('vm-script-path-input').value = result.data.vm_script_path || '';
                    document.getElementById('adb-path-input').value = result.data.adb_path || '';
                    document.getElementById('vm-accounts-file-path-input').value = result.data.vm_accounts_file_path || '';
                    document.getElementById('vm-model-config-path-input').value = result.data.vm_model_config_path || '';
                }
            } catch (error) {
                console.error('åŠ è½½è·¯å¾„é…ç½®å¤±è´¥:', error);
            }
            document.getElementById('path-settings-modal').classList.add('active');
        }

        // å…³é—­è·¯å¾„è®¾ç½®æ¨¡æ€æ¡†
        function closePathSettingsModal() {
            document.getElementById('path-settings-modal').classList.remove('active');
        }

        // ä¿å­˜è·¯å¾„è®¾ç½®
        async function savePathSettings(event) {
            event.preventDefault();
            const configFilePath = document.getElementById('config-file-path-input').value.trim();
            const vmScriptPath = document.getElementById('vm-script-path-input').value.trim();
            const adbPath = document.getElementById('adb-path-input').value.trim();
            const vmAccountsFilePath = document.getElementById('vm-accounts-file-path-input').value.trim();
            const vmModelConfigPath = document.getElementById('vm-model-config-path-input').value.trim();
            
            try {
                const response = await fetch('/api/settings/paths', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config_file_path: configFilePath,
                        vm_script_path: vmScriptPath,
                        adb_path: adbPath,
                        vm_accounts_file_path: vmAccountsFilePath,
                        vm_model_config_path: vmModelConfigPath
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', 'è·¯å¾„é…ç½®å·²ä¿å­˜');
                    closePathSettingsModal();
                } else {
                    showAlert('error', 'ä¿å­˜å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ==================== è®¾å¤‡ç®¡ç†åŠŸèƒ½ ====================
        
        function formatDeviceStatus(status) {
            const raw = (status || '').toString();
            const normalized = raw.trim().toLowerCase();

            if (normalized === 'device') {
                return '<span class="status-indicator"><span class="status-dot online"></span><span class="status-text online">ä¸Šçº¿</span></span>';
            }

            if (normalized === 'offline') {
                return '<span class="status-indicator"><span class="status-dot offline"></span><span class="status-text offline">ç¦»çº¿</span></span>';
            }

            if (normalized === 'unauthorized') {
                return '<span class="status-indicator"><span class="status-dot unauthorized"></span><span class="status-text unauthorized">æœªæˆæƒ</span></span>';
            }

            const safe = raw || '-';
            return `<span class="status-indicator"><span class="status-dot other"></span><span class="status-text other">${safe}</span></span>`;
        }

        // åˆ·æ–°å·²è¿æ¥è®¾å¤‡åˆ—è¡¨ï¼ˆå®æ—¶æ‰«æï¼‰
        async function refreshDeviceList() {
            const loading = document.getElementById('devices-scan-loading');
            const table = document.getElementById('devices-scan-table');
            const emptyState = document.getElementById('devices-scan-empty');
            const tbody = document.getElementById('devices-scan-tbody');
            const countEl = document.getElementById('device-count');

            loading.style.display = 'block';
            table.style.display = 'none';
            emptyState.style.display = 'none';

            try {
                const [devicesResponse, configsResponse] = await Promise.all([
                    fetch('/api/devices'),
                    fetch('/api/device-configs')
                ]);

                const devicesResult = await devicesResponse.json();
                const configsResult = await configsResponse.json();

                console.log('ğŸ“± å·²è¿æ¥è®¾å¤‡å“åº”:', devicesResult);
                console.log('ğŸ“¦ è®¾å¤‡é…ç½®å“åº”:', configsResult);

                const connectedDevices = devicesResult.success ? (devicesResult.data || []) : [];
                const savedConfigs = configsResult.success ? (configsResult.data || []) : [];

                // è¿æ¥çŠ¶æ€æ˜ å°„ï¼šconnectedDevice.id -> connectedDevice.status
                const connectedStatusMap = new Map();
                connectedDevices.forEach(d => {
                    if (d && d.id) connectedStatusMap.set(d.id, d.status || 'device');
                });

                // ä»¥â€œè®¾å¤‡é…ç½®åˆ—è¡¨â€ä¸ºä¸»æ¸²æŸ“ï¼ˆå³ä½¿è®¾å¤‡æœªè¿æ¥ä¹Ÿè¦å±•ç¤ºï¼‰ï¼Œå†è¡¥å……æœªä¿å­˜ä½†å·²è¿æ¥çš„è®¾å¤‡
                const mergedList = [];
                const seen = new Set();

                savedConfigs.forEach(cfg => {
                    const deviceId = cfg.device_id;
                    if (!deviceId || seen.has(deviceId)) return;
                    seen.add(deviceId);
                    mergedList.push({
                        device_id: deviceId,
                        remark: cfg.remark || '',
                        status: connectedStatusMap.get(deviceId) || 'offline'
                    });
                });

                connectedDevices.forEach(d => {
                    const deviceId = d.id;
                    if (!deviceId || seen.has(deviceId)) return;
                    seen.add(deviceId);
                    mergedList.push({
                        device_id: deviceId,
                        remark: '',
                        status: d.status || 'device'
                    });
                });

                countEl.textContent = `å…± ${mergedList.length} ä¸ªè®¾å¤‡`;

                if (mergedList.length === 0) {
                    loading.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                // è·å–å½“å‰è®¾å¤‡IDï¼ˆlocalStorageï¼‰
                let currentDeviceId = getCurrentDeviceId();
                console.log('ğŸ“Œ å½“å‰è®¾å¤‡ID:', currentDeviceId);

                // å¦‚æœæ²¡æœ‰å½“å‰è®¾å¤‡ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªâ€œå·²ä¿å­˜é…ç½®â€ï¼Œå¦åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªmerged
                if (!currentDeviceId) {
                    const firstPreferred = mergedList[0]?.device_id || null;
                    if (firstPreferred) {
                        currentDeviceId = firstPreferred;
                        localStorage.setItem('currentDeviceId', firstPreferred);
                        console.log('âœ¨ è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡:', firstPreferred);
                        await updateDeviceSelectorDisplay();
                    }
                }

                tbody.innerHTML = '';
                mergedList.forEach((device, index) => {
                    deviceRemarkMap.set(device.device_id, device.remark || '');
                    const isCurrentDevice = device.device_id === currentDeviceId;
                    console.log(`  è®¾å¤‡ ${index + 1}: ${device.device_id}, å¤‡æ³¨: ${device.remark || 'æ— '}, çŠ¶æ€: ${device.status}, å½“å‰: ${isCurrentDevice}`);

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="text-align: center;">
                            <input type="radio" 
                                   name="currentDevice" 
                                   value="${device.device_id}" 
                                   ${isCurrentDevice ? 'checked' : ''}
                                   onchange="setCurrentDevice('${device.device_id}')"
                                   style="cursor: pointer; width: 18px; height: 18px;">
                        </td>
                        <td>${device.remark || '-'}</td>
                        <td><code>${device.device_id}</code></td>
                        <td>${formatDeviceStatus(device.status)}</td>
                        <td>
                            <button class="btn-icon device-edit-remark" data-device-id="${device.device_id}" data-remark="${(device.remark || '').replace(/"/g, '&quot;')}" title="ç¼–è¾‘è®¾å¤‡">
                                âœï¸ ç¼–è¾‘
                            </button>
                        </td>
                    `;

                    const editBtn = row.querySelector('.device-edit-remark');
                    if (editBtn) {
                        editBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const dId = editBtn.getAttribute('data-device-id');
                            const remark = editBtn.getAttribute('data-remark') || '';
                            showEditRemarkModal(dId, remark);
                        });
                    }
                    tbody.appendChild(row);
                });

                loading.style.display = 'none';
                table.style.display = 'table';

                console.log('âœ… è®¾å¤‡åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('âŒ åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                showDeviceAlert('error', 'åˆ·æ–°è®¾å¤‡åˆ—è¡¨å¤±è´¥: ' + error.message);
                loading.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }
        
        // è®¾ç½®å½“å‰è®¾å¤‡
        async function setCurrentDevice(deviceId) {
            try {
                console.log(`ğŸ”„ åˆ‡æ¢å½“å‰è®¾å¤‡ä¸º: ${deviceId}`);

                const currentDeviceId = localStorage.getItem('currentDeviceId');
                if (currentDeviceId && currentDeviceId !== deviceId) {
                    const fromLabel = formatDeviceLabel(currentDeviceId);
                    const toLabel = formatDeviceLabel(deviceId);
                    const ok = confirm(`é«˜å±æ“ä½œï¼šç¡®å®šå°†å½“å‰è®¾å¤‡ä»\n${fromLabel}\nåˆ‡æ¢ä¸º\n${toLabel}\n\nåˆ‡æ¢åï¼Œæ‰€æœ‰ä»£ç†/ä¸­è½¬çº¿è·¯çš„æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤éƒ½ä¼šä¿®æ”¹è¯¥è®¾å¤‡çš„ç½‘ç»œé…ç½®ã€‚`);
                    if (!ok) {
                        return;
                    }
                }
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('currentDeviceId', deviceId);

                try {
                    await fetch('/api/current-device', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ device_id: deviceId })
                    });
                } catch (e) {
                    console.warn('âš ï¸ ä¿å­˜å½“å‰è®¾å¤‡åˆ°åç«¯å¤±è´¥:', e);
                }
                
                // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨æ˜¾ç¤º
                await updateDeviceSelectorDisplay();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showDeviceAlert('success', `å·²åˆ‡æ¢åˆ°è®¾å¤‡: ${deviceId}`);
                
                // å¦‚æœå½“å‰åœ¨ä»£ç†æˆ–ä¸­è½¬çº¿è·¯æ ‡ç­¾é¡µï¼Œé‡æ–°åŠ è½½æ•°æ®
                const currentTab = document.querySelector('.tab-btn.active');
                if (currentTab) {
                    const tabText = currentTab.textContent.trim();
                    if (tabText.includes('ä»£ç†åˆ—è¡¨')) {
                        loadProxies();
                    } else if (tabText.includes('ä¸­è½¬çº¿è·¯')) {
                        loadTransitProxies();
                    }
                }
            } catch (error) {
                console.error('âŒ åˆ‡æ¢è®¾å¤‡å¤±è´¥:', error);
                showDeviceAlert('error', 'åˆ‡æ¢è®¾å¤‡å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºç¼–è¾‘å¤‡æ³¨æ¨¡æ€æ¡†
        function showEditRemarkModal(deviceId, currentRemark) {
            document.getElementById('edit-remark-device-id').value = deviceId;
            document.getElementById('edit-remark-input').value = currentRemark || '';
            document.getElementById('edit-remark-modal').classList.add('active');
            // èšç„¦åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('edit-remark-input').focus();
            }, 100);
        }
        
        // å…³é—­ç¼–è¾‘å¤‡æ³¨æ¨¡æ€æ¡†
        function closeEditRemarkModal() {
            document.getElementById('edit-remark-modal').classList.remove('active');
            document.getElementById('edit-remark-form').reset();
        }
        
        // ä»æ¨¡æ€æ¡†ä¿å­˜è®¾å¤‡å¤‡æ³¨
        async function saveDeviceRemarkFromModal(event) {
            event.preventDefault();
            const deviceId = document.getElementById('edit-remark-device-id').value.trim();
            const remark = document.getElementById('edit-remark-input').value.trim();
            
            if (!deviceId) {
                showDeviceAlert('error', 'è®¾å¤‡IDä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const response = await fetch('/api/device-configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_id: deviceId,
                        remark: remark
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showDeviceAlert('success', 'å¤‡æ³¨å·²ä¿å­˜');
                    closeEditRemarkModal();
                    refreshDeviceList(); // åˆ·æ–°è®¾å¤‡åˆ—è¡¨ä»¥æ›´æ–°å¤‡æ³¨æ˜¾ç¤º
                } else {
                    showDeviceAlert('error', 'ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showDeviceAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºè®¾å¤‡ç®¡ç†æç¤º
        function showDeviceAlert(type, message) {
            const container = document.getElementById('device-alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.marginBottom = '15px';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // ==================== æ—§è®¾å¤‡åˆ—è¡¨åŠŸèƒ½ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰ ====================
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼ˆæ—§ç‰ˆæœ¬ï¼Œå·²åºŸå¼ƒï¼‰
        async function loadDevices() {
            const loading = document.getElementById('devices-loading');
            const list = document.getElementById('devices-list');
            const empty = document.getElementById('devices-empty');
            const error = document.getElementById('devices-error');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            list.style.display = 'none';
            empty.style.display = 'none';
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/devices');
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (result.success) {
                    const devices = result.data || [];
                    
                    if (devices.length === 0) {
                        // æ²¡æœ‰è®¾å¤‡
                        empty.style.display = 'block';
                        list.style.display = 'none';
                    } else {
                        // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
                        empty.style.display = 'none';
                        list.style.display = 'grid';
                        list.innerHTML = '';
                        
                        devices.forEach((device, index) => {
                            const deviceCard = document.createElement('div');
                            deviceCard.style.cssText = 'padding: 12px 16px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;';
                            deviceCard.onmouseover = function() { this.style.borderColor = '#3b82f6'; this.style.boxShadow = '0 2px 4px rgba(59, 130, 246, 0.1)'; };
                            deviceCard.onmouseout = function() { this.style.borderColor = '#e5e7eb'; this.style.boxShadow = 'none'; };
                            
                            // è®¾å¤‡çŠ¶æ€å¾½ç« 
                            let statusBadge = '';
                            if (device.status === 'device') {
                                statusBadge = '<span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">âœ“ å·²è¿æ¥</span>';
                            } else if (device.status === 'unauthorized') {
                                statusBadge = '<span style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">âš  æœªæˆæƒ</span>';
                            } else if (device.status === 'offline') {
                                statusBadge = '<span style="background: #ef4444; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">âœ— ç¦»çº¿</span>';
                            } else {
                                statusBadge = `<span style="background: #6b7280; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500;">${device.status || 'æœªçŸ¥'}</span>`;
                            }
                            
                            deviceCard.innerHTML = `
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: #374151; margin-bottom: 4px; font-family: "Consolas", "Monaco", monospace; font-size: 14px; word-break: break-all;">
                                        ğŸ“± ${device.id}
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280;">
                                        è®¾å¤‡ #${index + 1}
                                    </div>
                                </div>
                                <div style="margin-left: 12px; flex-shrink: 0;">
                                    ${statusBadge}
                                </div>
                            `;
                            
                            list.appendChild(deviceCard);
                        });
                    }
                } else {
                    // æ˜¾ç¤ºé”™è¯¯
                    error.style.display = 'block';
                    error.innerHTML = `<p style="margin: 0;">âŒ ${result.error || 'è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥'}</p>`;
                    list.style.display = 'none';
                    empty.style.display = 'none';
                }
            } catch (error) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.innerHTML = `<p style="margin: 0;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</p>`;
                list.style.display = 'none';
                empty.style.display = 'none';
            }
        }

        // åŠ è½½è®¾å¤‡é…ç½®åˆ—è¡¨ï¼ˆç”¨äºè®¾å¤‡ç®¡ç†æ ‡ç­¾é¡µï¼‰
        async function loadDeviceConfigs() {
            // è¿™ä¸ªå‡½æ•°æš‚æ—¶ä¸ºç©ºï¼Œè®¾å¤‡é…ç½®é€šè¿‡refreshDeviceListæ˜¾ç¤º
            console.log('ğŸ“‹ åŠ è½½è®¾å¤‡é…ç½®...');
        }
        // ==================== åˆ†é¡µå’Œæœç´¢åŠŸèƒ½ ====================
        
        // åˆ†é¡µçŠ¶æ€ç®¡ç†
        const paginationState = {
            proxies: { currentPage: 1, pageSize: 20, searchTerm: '', dialerFilter: '', allData: [] },
            transit: { currentPage: 1, pageSize: 20, searchTerm: '', allData: [] },
            devices: { currentPage: 1, pageSize: 20, searchTerm: '', allData: [] }
        };

        const deviceRemarkMap = new Map();
        
        // é€šç”¨åˆ†é¡µå‡½æ•°
        function paginateData(data, page, pageSize) {
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            return data.slice(start, end);
        }
        
        // é€šç”¨æœç´¢è¿‡æ»¤å‡½æ•°
        function filterDataByName(data, searchTerm) {
            if (!searchTerm) return data;
            const term = searchTerm.toLowerCase();
            return data.filter(item => {
                const name = item.name || '';
                return name.toLowerCase().includes(term);
            });
        }
        
        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination(containerId, totalItems, currentPage, pageSize, onPageChange) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const totalPages = Math.ceil(totalItems / pageSize);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination">';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            html += `<button onclick="${onPageChange}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç æŒ‰é’®
            const maxButtons = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            if (startPage > 1) {
                html += `<button onclick="${onPageChange}(1)">1</button>`;
                if (startPage > 2) html += '<span style="padding: 0 8px;">...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${onPageChange}(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span style="padding: 0 8px;">...</span>';
                html += `<button onclick="${onPageChange}(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            html += `<button onclick="${onPageChange}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // æ¸²æŸ“åˆ†é¡µä¿¡æ¯
        function renderPaginationInfo(containerId, totalItems, currentPage, pageSize) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const start = totalItems === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalItems);
            
            container.innerHTML = `æ˜¾ç¤º ${start}-${end} æ¡ï¼Œå…± ${totalItems} æ¡`;
        }
        
        // ä»£ç†åˆ—è¡¨æœç´¢
        function searchProxies(term) {
            paginationState.proxies.searchTerm = term;
            paginationState.proxies.currentPage = 1;
            renderProxiesPage();
        }
        
        // æŒ‰ä¸­è½¬çº¿è·¯è¿‡æ»¤ä»£ç†
        function filterProxiesByDialer(dialerName) {
            paginationState.proxies.dialerFilter = dialerName;
            paginationState.proxies.currentPage = 1;
            renderProxiesPage();
        }
        
        // ä»£ç†åˆ—è¡¨ç¿»é¡µ
        function goToProxyPage(page) {
            paginationState.proxies.currentPage = page;
            renderProxiesPage();
        }
        
        // æ¸²æŸ“ä»£ç†åˆ—è¡¨é¡µé¢
        function renderProxiesPage() {
            const state = paginationState.proxies;
            
            // å…ˆæŒ‰åç§°è¿‡æ»¤
            let filteredData = filterDataByName(state.allData, state.searchTerm);
            
            // å†æŒ‰ä¸­è½¬çº¿è·¯è¿‡æ»¤
            if (state.dialerFilter) {
                if (state.dialerFilter === '__none__') {
                    // è¿‡æ»¤å‡ºæ²¡æœ‰ä¸­è½¬çº¿è·¯çš„ä»£ç†
                    filteredData = filteredData.filter(proxy => !proxy['dialer-proxy']);
                } else {
                    // è¿‡æ»¤å‡ºæŒ‡å®šä¸­è½¬çº¿è·¯çš„ä»£ç†
                    filteredData = filteredData.filter(proxy => {
                        const dialerProxy = proxy['dialer-proxy'] || '';
                        return dialerProxy === state.dialerFilter;
                    });
                }
            }
            
            const pageData = paginateData(filteredData, state.currentPage, state.pageSize);
            
            const tbody = document.getElementById('proxy-tbody');
            tbody.innerHTML = '';
            pageData.forEach((proxy, index) => {
                const globalIndex = (state.currentPage - 1) * state.pageSize + index;
                const row = createProxyRow(proxy, globalIndex);
                tbody.appendChild(row);
            });
            
            renderPaginationInfo('proxy-pagination-info', filteredData.length, state.currentPage, state.pageSize);
            renderPagination('proxy-pagination', filteredData.length, state.currentPage, state.pageSize, 'goToProxyPage');
        }
        
        // ä¸­è½¬çº¿è·¯æœç´¢
        function searchTransit(term) {
            paginationState.transit.searchTerm = term;
            paginationState.transit.currentPage = 1;
            renderTransitPage();
        }
        
        // ä¸­è½¬çº¿è·¯ç¿»é¡µ
        function goToTransitPage(page) {
            paginationState.transit.currentPage = page;
            renderTransitPage();
        }
        
        // æ¸²æŸ“ä¸­è½¬çº¿è·¯é¡µé¢
        function renderTransitPage() {
            const state = paginationState.transit;
            const filteredData = filterDataByName(state.allData, state.searchTerm);
            const pageData = paginateData(filteredData, state.currentPage, state.pageSize);
            
            const tbody = document.getElementById('transit-tbody');
            tbody.innerHTML = '';
            pageData.forEach((proxy, index) => {
                const globalIndex = (state.currentPage - 1) * state.pageSize + index;
                const row = createTransitRow(proxy, globalIndex);
                tbody.appendChild(row);
            });
            
            renderPaginationInfo('transit-pagination-info', filteredData.length, state.currentPage, state.pageSize);
            renderPagination('transit-pagination', filteredData.length, state.currentPage, state.pageSize, 'goToTransitPage');
        }
        
        // è®¾å¤‡åˆ—è¡¨æœç´¢
        function searchDevices(term) {
            paginationState.devices.searchTerm = term;
            paginationState.devices.currentPage = 1;
            renderDevicesPage();
        }
        
        // è®¾å¤‡åˆ—è¡¨ç¿»é¡µ
        function goToDevicePage(page) {
            paginationState.devices.currentPage = page;
            renderDevicesPage();
        }
        
        // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨é¡µé¢
        function renderDevicesPage() {
            const state = paginationState.devices;
            const filteredData = state.allData.filter(device => {
                if (!state.searchTerm) return true;
                const term = state.searchTerm.toLowerCase();
                return (device.device_id || '').toLowerCase().includes(term) ||
                       (device.remark || '').toLowerCase().includes(term);
            });
            const pageData = paginateData(filteredData, state.currentPage, state.pageSize);
            
            const tbody = document.getElementById('device-tbody');
            tbody.innerHTML = '';
            pageData.forEach(device => {
                const row = createDeviceRow(device);
                tbody.appendChild(row);
            });
            
            renderPaginationInfo('device-pagination-info', filteredData.length, state.currentPage, state.pageSize);
            renderPagination('device-pagination', filteredData.length, state.currentPage, state.pageSize, 'goToDevicePage');
        }
        
        // ==================== è®¾å¤‡é€‰æ‹©å™¨ç®¡ç† ====================
        
        // è·å–å½“å‰è®¾å¤‡ID
        function getCurrentDeviceId() {
            const value = localStorage.getItem('currentDeviceId');
            // é¿å…è¿”å›'undefined'å­—ç¬¦ä¸²æˆ–ç©ºå­—ç¬¦ä¸²ï¼Œè¿”å›null
            return (value && value !== 'undefined' && value !== '') ? value : null;
        }

        function formatDeviceLabel(deviceId) {
            const id = (deviceId && deviceId !== 'undefined' && deviceId !== '') ? deviceId : '';
            const remark = deviceRemarkMap.get(id) || '';
            const remarkText = remark ? remark : 'æ— ';
            return `ã€${remarkText}ã€‘(${id})`;
        }
        
        // æ„å»ºå¸¦device_idçš„URL
        function buildUrlWithDeviceId(baseUrl) {
            const deviceId = getCurrentDeviceId();
            if (deviceId) {
                const separator = baseUrl.includes('?') ? '&' : '?';
                return `${baseUrl}${separator}device_id=${encodeURIComponent(deviceId)}`;
            }
            return baseUrl;
        }
        
        // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨æ˜¾ç¤º
        async function updateDeviceSelectorDisplay() {
            try {
                console.log('ğŸ”„ æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨æ˜¾ç¤º...');
                
                // å…ˆå°è¯•è·å–å·²è¿æ¥çš„è®¾å¤‡ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶å¤¹ï¼‰
                const devicesResponse = await fetch('/api/devices');
                const devicesResult = await devicesResponse.json();
                console.log('ğŸ“¥ å·²è¿æ¥è®¾å¤‡:', devicesResult);
                
                // è·å–å·²ä¿å­˜çš„è®¾å¤‡é…ç½®
                const configsResponse = await fetch('/api/device-configs');
                const configsResult = await configsResponse.json();
                console.log('ğŸ“¥ è®¾å¤‡é…ç½®åˆ—è¡¨:', configsResult);
                
                const display = document.getElementById('currentDeviceDisplay');
                
                if (configsResult.success) {
                    const devices = configsResult.data || [];
                    console.log(`ğŸ“± æ‰¾åˆ° ${devices.length} ä¸ªè®¾å¤‡é…ç½®`);

                    devices.forEach(d => {
                        if (d && d.device_id) deviceRemarkMap.set(d.device_id, d.remark || '');
                    });
                    
                    if (devices.length === 0) {
                        display.textContent = 'æ— è®¾å¤‡ - è¯·å…ˆåˆ·æ–°è®¾å¤‡åˆ—è¡¨';
                        display.style.color = '#ef4444';
                        console.warn('âš ï¸ æ²¡æœ‰è®¾å¤‡é…ç½®ï¼Œè¯·åˆ°è®¾å¤‡ç®¡ç†æ ‡ç­¾åˆ·æ–°è®¾å¤‡åˆ—è¡¨');
                        return;
                    }
                    
                    // ä»localStorageè·å–å½“å‰è®¾å¤‡
                    const currentDeviceId = localStorage.getItem('currentDeviceId');
                    const currentDevice = devices.find(d => d.device_id === currentDeviceId);
                    
                    if (currentDevice) {
                        display.textContent = currentDevice.remark ? 
                            `${currentDevice.device_id} (${currentDevice.remark})` : 
                            currentDevice.device_id;
                        display.style.color = '#10b981';
                        console.log(`âœ… å½“å‰è®¾å¤‡: ${currentDevice.device_id}`);
                    } else if (devices.length > 0) {
                        // å¦‚æœæ²¡æœ‰å½“å‰è®¾å¤‡æˆ–å½“å‰è®¾å¤‡ä¸å­˜åœ¨ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                        const firstDevice = devices[0];
                        localStorage.setItem('currentDeviceId', firstDevice.device_id);
                        display.textContent = firstDevice.remark ? 
                            `${firstDevice.device_id} (${firstDevice.remark})` : 
                            firstDevice.device_id;
                        display.style.color = '#10b981';
                        console.log(`âœ… é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡: ${firstDevice.device_id}`);
                    }
                } else {
                    console.error('âŒ åŠ è½½è®¾å¤‡é…ç½®å¤±è´¥:', configsResult.error);
                    display.textContent = 'åŠ è½½å¤±è´¥ - è¯·åˆ·æ–°é¡µé¢';
                    display.style.color = '#ef4444';
                }
            } catch (error) {
                console.error('âŒ æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨æ˜¾ç¤ºå¼‚å¸¸:', error);
                const display = document.getElementById('currentDeviceDisplay');
                if (display) {
                    display.textContent = 'åŠ è½½å¼‚å¸¸ - è¯·æ£€æŸ¥ç½‘ç»œ';
                    display.style.color = '#ef4444';
                }
            }
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨åˆ°é€‰æ‹©å™¨
        async function loadDeviceList() {
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½è®¾å¤‡é…ç½®åˆ—è¡¨...');

                const selector = document.getElementById('deviceSelector');
                if (!selector) {
                    console.log('â„¹ï¸ deviceSelector ä¸å­˜åœ¨ï¼Œè·³è¿‡æ—§ç‰ˆ loadDeviceList()');
                    return;
                }
                
                // å…ˆå°è¯•è·å–å·²è¿æ¥çš„è®¾å¤‡ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶å¤¹ï¼‰
                const devicesResponse = await fetch('/api/devices');
                const devicesResult = await devicesResponse.json();
                console.log('ğŸ“¥ å·²è¿æ¥è®¾å¤‡:', devicesResult);
                
                // è·å–å·²ä¿å­˜çš„è®¾å¤‡é…ç½®ï¼ˆç”¨äºè®¾å¤‡é€‰æ‹©å™¨ï¼‰
                const configsResponse = await fetch('/api/device-configs');
                const configsResult = await configsResponse.json();
                console.log('ğŸ“¥ è®¾å¤‡é…ç½®åˆ—è¡¨:', configsResult);
                
                if (configsResult.success) {
                    const devices = configsResult.data || [];
                    
                    console.log(`ğŸ“± æ‰¾åˆ° ${devices.length} ä¸ªè®¾å¤‡é…ç½®`);
                    
                    if (devices.length === 0) {
                        selector.innerHTML = '<option value="">æ— è®¾å¤‡é…ç½® - è¯·å…ˆåˆ·æ–°è®¾å¤‡åˆ—è¡¨</option>';
                        selector.disabled = true;
                        console.warn('âš ï¸ æ²¡æœ‰è®¾å¤‡é…ç½®ï¼Œè¯·åˆ°è®¾å¤‡ç®¡ç†æ ‡ç­¾åˆ·æ–°è®¾å¤‡åˆ—è¡¨');
                        return;
                    }
                    
                    selector.disabled = false;
                    selector.innerHTML = '';
                    
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.device_id;
                        option.textContent = device.remark ? 
                            `${device.device_id} (${device.remark})` : 
                            device.device_id;
                        selector.appendChild(option);
                        console.log(`  âœ… æ·»åŠ è®¾å¤‡: ${device.device_id}`);
                    });
                    
                    // ä»localStorageæ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„è®¾å¤‡
                    const lastDevice = localStorage.getItem('currentDeviceId');
                    if (lastDevice && devices.some(d => d.device_id === lastDevice)) {
                        selector.value = lastDevice;
                        console.log(`âœ… æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„è®¾å¤‡: ${lastDevice}`);
                    } else if (devices.length > 0) {
                        selector.value = devices[0].device_id;
                        localStorage.setItem('currentDeviceId', devices[0].device_id);
                        console.log(`âœ… é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡: ${devices[0].device_id}`);
                    }
                } else {
                    console.error('âŒ åŠ è½½è®¾å¤‡é…ç½®å¤±è´¥:', configsResult.error);
                    selector.innerHTML = '<option value="">åŠ è½½å¤±è´¥ - è¯·åˆ·æ–°é¡µé¢</option>';
                    selector.disabled = true;
                }
            } catch (error) {
                console.error('âŒ åŠ è½½è®¾å¤‡é…ç½®å¼‚å¸¸:', error);
                const selector = document.getElementById('deviceSelector');
                if (selector) {
                    selector.innerHTML = '<option value="">åŠ è½½å¼‚å¸¸ - è¯·æ£€æŸ¥ç½‘ç»œ</option>';
                    selector.disabled = true;
                }
            }
        }
        
        // åˆ‡æ¢è®¾å¤‡
        function switchDevice() {
            const selector = document.getElementById('deviceSelector');
            if (!selector) {
                console.log('â„¹ï¸ deviceSelector ä¸å­˜åœ¨ï¼Œè·³è¿‡æ—§ç‰ˆ switchDevice()');
                return;
            }
            const deviceId = selector.value;
            
            if (deviceId) {
                localStorage.setItem('currentDeviceId', deviceId);
                showNotification(`å·²åˆ‡æ¢åˆ°è®¾å¤‡: ${deviceId}`, 'success');
                
                // é‡æ–°åŠ è½½æ•°æ®
                const currentTab = document.querySelector('.tab-btn.active').textContent.trim();
                if (currentTab.includes('ä»£ç†åˆ—è¡¨')) {
                    loadProxies();
                } else if (currentTab.includes('ä¸­è½¬çº¿è·¯')) {
                    loadTransit();
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

            try {
                const currentDeviceId = localStorage.getItem('currentDeviceId');
                if (!currentDeviceId || currentDeviceId === 'undefined' || currentDeviceId === '') {
                    const resp = await fetch('/api/current-device');
                    const result = await resp.json();
                    if (result.success && result.data && result.data.device_id) {
                        localStorage.setItem('currentDeviceId', result.data.device_id);
                    }
                }
            } catch (e) {
                console.warn('âš ï¸ è¯»å–åç«¯å½“å‰è®¾å¤‡å¤±è´¥:', e);
            }
            
            // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨æ˜¾ç¤º
            await updateDeviceSelectorDisplay();
            
            // åŠ è½½åˆå§‹æ•°æ®
            console.log('ğŸ“Š å¼€å§‹åŠ è½½åˆå§‹æ•°æ®...');
            
            // é»˜è®¤åœ¨è®¾å¤‡ç®¡ç†æ ‡ç­¾é¡µ
            refreshDeviceList();
            
            // é¢„åŠ è½½å…¶ä»–æ•°æ®
            loadTransitProxyNames();
            loadRegions();
        });
        
    </script>
</body>
</html>

