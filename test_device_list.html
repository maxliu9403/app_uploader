<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è®¾å¤‡åˆ—è¡¨æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ” è®¾å¤‡åˆ—è¡¨æ¸²æŸ“æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•1: æ£€æŸ¥APIå“åº”</h2>
        <button onclick="testAPI()">æµ‹è¯• /api/devices</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•2: æ£€æŸ¥DOMå…ƒç´ </h2>
        <button onclick="testDOM()">æ£€æŸ¥DOMå…ƒç´ </button>
        <div id="dom-result"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•3: æ‰‹åŠ¨æ¸²æŸ“è®¾å¤‡åˆ—è¡¨</h2>
        <button onclick="testRender()">æ‰‹åŠ¨æ¸²æŸ“</button>
        <div id="render-result"></div>
        
        <!-- æ¨¡æ‹Ÿçš„è®¾å¤‡è¡¨æ ¼ -->
        <table id="test-devices-table" style="display: none;">
            <thead>
                <tr>
                    <th>å½“å‰è®¾å¤‡</th>
                    <th>å¤‡æ³¨</th>
                    <th>è®¾å¤‡ID</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="test-devices-tbody"></tbody>
        </table>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•4: æ£€æŸ¥localStorage</h2>
        <button onclick="testLocalStorage()">æ£€æŸ¥localStorage</button>
        <button onclick="clearLocalStorage()">æ¸…é™¤localStorage</button>
        <div id="storage-result"></div>
    </div>

    <script>
        // æµ‹è¯•1: APIå“åº”
        async function testAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>æ­£åœ¨è¯·æ±‚...</p>';
            
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <p class="success">âœ… APIå“åº”æˆåŠŸ</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">âŒ APIè¯·æ±‚å¤±è´¥: ${error.message}</p>
                `;
            }
        }
        
        // æµ‹è¯•2: DOMå…ƒç´ 
        function testDOM() {
            const resultDiv = document.getElementById('dom-result');
            const checks = [];
            
            // æ£€æŸ¥ä¸»é¡µé¢çš„å…ƒç´ 
            const elements = [
                'devices-scan-loading',
                'devices-scan-table',
                'devices-scan-empty',
                'devices-scan-tbody',
                'device-count'
            ];
            
            elements.forEach(id => {
                const el = window.parent.document.getElementById(id);
                if (el) {
                    checks.push(`âœ… ${id}: å­˜åœ¨`);
                } else {
                    checks.push(`âŒ ${id}: ä¸å­˜åœ¨`);
                }
            });
            
            resultDiv.innerHTML = `
                <p><strong>DOMå…ƒç´ æ£€æŸ¥:</strong></p>
                <pre>${checks.join('\n')}</pre>
            `;
        }
        
        // æµ‹è¯•3: æ‰‹åŠ¨æ¸²æŸ“
        async function testRender() {
            const resultDiv = document.getElementById('render-result');
            const table = document.getElementById('test-devices-table');
            const tbody = document.getElementById('test-devices-tbody');
            
            resultDiv.innerHTML = '<p>æ­£åœ¨æ¸²æŸ“...</p>';
            
            try {
                const response = await fetch('/api/devices');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const devices = result.data;
                    tbody.innerHTML = '';
                    
                    devices.forEach((device, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="text-align: center;">
                                <input type="radio" name="testDevice" value="${device.device_id}" 
                                       ${index === 0 ? 'checked' : ''}>
                            </td>
                            <td>${device.remark || '-'}</td>
                            <td><code>${device.device_id}</code></td>
                            <td>${device.status}</td>
                            <td>ğŸ’¾</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.style.display = 'table';
                    resultDiv.innerHTML = `<p class="success">âœ… æˆåŠŸæ¸²æŸ“ ${devices.length} ä¸ªè®¾å¤‡</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ æ²¡æœ‰è®¾å¤‡æ•°æ®</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ æ¸²æŸ“å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æµ‹è¯•4: localStorage
        function testLocalStorage() {
            const resultDiv = document.getElementById('storage-result');
            const currentDeviceId = localStorage.getItem('currentDeviceId');
            
            resultDiv.innerHTML = `
                <p><strong>localStorageå†…å®¹:</strong></p>
                <pre>currentDeviceId: ${currentDeviceId || '(æœªè®¾ç½®)'}</pre>
                <p>æ‰€æœ‰localStorageé¡¹:</p>
                <pre>${JSON.stringify(localStorage, null, 2)}</pre>
            `;
        }
        
        function clearLocalStorage() {
            localStorage.clear();
            alert('localStorageå·²æ¸…é™¤');
            testLocalStorage();
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            console.log('ğŸ§ª æµ‹è¯•é¡µé¢å·²åŠ è½½');
            testAPI();
            testLocalStorage();
        };
    </script>
</body>
</html>
